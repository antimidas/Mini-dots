import{b as re}from"./chunk-ZMUT3H36.js";import{g as O,i as te}from"./chunk-JMZ6COH5.js";import{d as b}from"./chunk-UK623MXR.js";import{a as ae}from"./chunk-DB2INE3Z.js";import{a as M}from"./chunk-5DIWEA5K.js";import{a as oe,b as L,c as K,e as A}from"./chunk-C3OCDYXE.js";import{a as ee}from"./chunk-VMXEY2MG.js";import{a as se}from"./chunk-VQDKWH7E.js";import{a as X,b as Z,c as R}from"./chunk-542QW3ZK.js";import{a as I,b as C,e as F}from"./chunk-JNO5G2QC.js";import{e as w,g as N}from"./chunk-TXXCCNWI.js";import{c as he,g as J,i as z,j as Q,m,n as U,s as j,t as H,w as B}from"./chunk-CHZKSFGE.js";import{z as $}from"./chunk-T5WNPH4X.js";import{a as Y,c as ge}from"./chunk-IUWVXOWN.js";import{c as x}from"./chunk-HPNQXUCM.js";import{e as f}from"./chunk-3GYLW4KZ.js";var G=f(x());var ne=e=>B("getPostCheckoutDeals",e);var ie=e=>B("getPostCheckoutFeedsForTypes",e);async function ke(e){return await ne({context:b(),contentProps:{type:e,fillWithFallback:j("ext_post_checkout_fallback_deals")}})}async function Oe(e){return await ie({context:b(),contentProps:{types:e,fillWithFallback:j("ext_post_checkout_fallback_deals")}})}async function ce(e,a={},g={}){let r=await ke(g.type??"deals"),c=r.items.length>0?r.items[0]:void 0,d=Z(e),k=await R(d),s={rootEl:"div",logLevel:null},u=G.default.reduce(r.items,(p,n)=>{let v=G.default.get(n,["stats","cashback"],"0%").replace("up to ","");return v>p?v:p},"0%"),l={offers:r,deals:r?.items,currentDeal:c,threshold:c?.stats?.rewardTiers?.[0]?.displaySpendCents??"",threshold_reward:c?.stats?.rewardTiers?.[0]?.reward?.displayValue??"",currentDealCashback:c?.stats?.cashback,dealRewardType:c?.stats?.rewardType??"percentage",notification_text:JSON.stringify({offerCount:r?.items?.length,highestRate:u}),...a},y={threshold:l.threshold,threshold_reward:l.threshold_reward,currentDealCashback:l.currentDealCashback,dealRewardType:l.dealRewardType,offerCount:r.items?.length,currentDeal:c,highestRate:u},i=await A();return{config:s,content:k,data:l,meta:y,...i}}var E=f($()),_=f(x()),le=f(he());var P=e=>B("activateOfferInNewTab",e);var V=f(w());function ve({eventName:e="postCheckoutRetargeting",onUnload:a,onRenderComplete:g,blocksParams:r,providedData:c={},blocksSlug:d,contentProps:k={}}){let[s,u]=(0,E.useState)(r),[l,y]=(0,E.useState)(void 0);function i(t,o,h,S={}){O(e,t,o,h,S)}let p=t=>{let o=_.default.get(s?.data,"deals");if(o&&o[t]){let h=o[t],S=(0,le.v4)(),q={redirect:!0,cashback:!!h.stats.cashback,meta:JSON.stringify({index:t,view:d,cashback:h.stats.cashback,merchantName:h.merchantName,redirectId:S,dealsLength:o.length})};i("","cta","primary",q);let ue=h.href.replace("__WBCLICKID__",S).replace("subExperience=best_on_web","subExperience=post_checkout");P({link:ue})}a&&a()},n=()=>{let t=_.default.get(s?.data,"deals");if(t){let o={redirect:!0,meta:JSON.stringify({dealsLength:t.length})};i("See all Offers","cta","secondary",o),P({link:N})}a&&a()},v=t=>{if(L(t,a),t.type===C.RenderComplete&&t.data&&g?.(t.data.isEmpty),t.type===C.NotificationDismiss&&i("x","dismiss","primary"),t.type===C.Custom&&t.data){let o=t.data.propsData;o?.view==="non_product_retargeting"&&o?.link?(P({link:o.link}),a&&a()):t.eventName==="dealClick"&&_.default.isNumber(o?.index)?p(o.index):t.eventName==="allDealsClickToApp"||t.eventName==="allDealsClick"?n():t.eventName==="singleOfferClick"&&p(0)}};return(0,E.useEffect)(()=>{r&&!_.default.isEqual(r,s)&&u(r)},[r,s]),(0,E.useEffect)(()=>{async function t(){try{let o=await ce(d,c,k);if(u(o),!_.default.get(o,["data","deals"])?.length)H("page",e,{view:"no_offers_available",meta:JSON.stringify({blocksSlug:d,contentProps:k})});else{let S=_.default.get(o,"meta",{}),q=JSON.stringify({contentProps:k,...S});H("page",e,{view:d,meta:q})}}catch(o){o instanceof Error&&y(o),console.error(o)}}t()},[]),l?null:s?(0,V.jsx)(F,{client:I.DESKTOP_WEB,config:s.config,content:s.content,host:s.host,user:s.user,data:s.data,onEvent:v,onRequest:K}):(0,V.jsx)("div",{className:"flex flex-1 align-center justify-center",children:(0,V.jsx)(M,{})})}function Be(e){J({message:"saveThrottle",throttleKey:e})}function Ce(e,a){return J({message:"checkSavedThrottle",throttleDurationMs:e,throttleKey:a??oe})}z(Be);Q(Ce);var T=f($()),fe=f(x());var D=f(x());ge();var me=e=>B("getTopDeals",e);async function _e(){let[e,a,g,r]=await Promise.all([se(),ee(),te(),ae()]);e&&(m.set("pageViewId",window.__wb_page_view_id),m.set("session",D.default.get(e,"session")),m.set("events",D.default.get(e,"settings.events")),m.set("settings",D.default.get(e,"settings")),m.set("tabId",D.default.get(e,"tabId")),m.set("lexiFetchResponse",D.default.get(e,"lexiFetchResponse"))),m.merge({siteAPIData:a}),m.merge({cashback:g}),m.set("lifetimeSavings",r)}async function Se(){try{return(await chrome.storage.local.get("lastCouponSavings"))?.lastCouponSavings??0}catch(e){return Y("Error fetching lastCouponSavings, defaulting to 0",e),0}}async function pe(e,a,g={},r=!1){let c=U("top_deals_post_checkout"),d=r&&(c||"post-checkout-deals-non-vm"===a),[k,s,u]=await Promise.all([await _e(),await Se(),d?me({context:b(),loadPage:null}):Promise.resolve({})]),l=m.get("siteAPIData"),y=l?.siteData?.cashback?.reward||{},i=m.get("cashback"),p=X(a),n=U("should_use_blocks_service")&&p?await R(p):void 0,v=n||await re(e),t={rootEl:"div",logLevel:null},o={...u,$savings:{couponSavings:s??0,cashbackActivated:!!i?.user?.activated,couponsActivated:s>0},topRewardsTypes:u,siteReward:y,couponSavings:s??0,...g},h=await A();return{config:t,content:v,data:o,...h}}var W=f(w());function de({contentSlug:e,onUnload:a,onRenderComplete:g,blocksParams:r,isPreloadingBlocks:c=!1,providedData:d={},includeTopDeals:k=!1,blocksSlug:s,children:u}){function l(n,v,t,o={}){O("postCheckoutRetargeting",n,v,t,o)}let y=n=>{L(n,a),n.type===C.NotificationDismiss&&s==="post-checkout-deals-non-vm"&&l("x","dismiss","primary"),n.type===C.RenderComplete&&n.data?g?.(n.data.isEmpty):n.type===C.Custom&&n.data&&n.eventName==="exploreDeals"&&s==="post-checkout-deals-non-vm"&&(l("View Savings","cta","primary"),P({link:N}),a&&a())},[i,p]=(0,T.useState)(r);return(0,T.useEffect)(()=>{r&&!fe.default.isEqual(r,i)&&p(r)},[r,i]),(0,T.useEffect)(()=>{!c&&!r&&pe(e,s,d,k).then(n=>p(n)).catch(console.error)},[]),i?(0,W.jsx)(F,{client:I.DESKTOP_WEB,config:i.config,content:i.content,host:i.host,user:i.user,data:i.data,onEvent:y,onRequest:K,children:u}):(0,W.jsx)("div",{className:"flex flex-1 align-center justify-center",children:(0,W.jsx)(M,{})})}export{ke as a,Oe as b,pe as c,ve as d,Be as e,Ce as f,de as g};
