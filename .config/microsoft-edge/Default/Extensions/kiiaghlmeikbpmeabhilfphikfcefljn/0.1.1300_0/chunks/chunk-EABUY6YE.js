import{a as de}from"./chunk-ECXCPAF6.js";import{j as ce,k as le}from"./chunk-53OM6ECF.js";import{c as _}from"./chunk-3GYLW4KZ.js";var K=_(U=>{"use strict";Object.defineProperty(U,"__esModule",{value:!0});U.decodePayload=void 0;function fe(n){let e=n.split(".")[1],r=atob(e);return JSON.parse(r)}U.decodePayload=fe});var Q=_(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.RewardTokenMinMap=m.RewardTokenMaxMap=m.transformKeys=m.inflateRewardsToken=m.minifyRewardsToken=void 0;function me(n){return S(n,m.RewardTokenMinMap)}m.minifyRewardsToken=me;function pe(n){return S(n,m.RewardTokenMaxMap)}m.inflateRewardsToken=pe;function S(n,e){if(typeof n!="object"||n===null)return n;if(Array.isArray(n))return n.map(t=>S(t,e));let r={};for(let t in n)if(Object.prototype.hasOwnProperty.call(n,t)){let o=e.get(t)||t;r[o]=S(n[t],e)}return r}m.transformKeys=S;var ee={v:"version",i:"id",u:"userId",d:"domain",e:"expiration",w:"publisher",t:"type",a:"amount",b:"amountCurrency",p:"maxPayoutAmount",q:"maxPayoutAmountCurrency",c:"categories",k:"cookie",l:"tiers",n:"name",r:"reward",x:"value",s:"spendCents"};m.RewardTokenMaxMap=new Map(Object.entries(ee));m.RewardTokenMinMap=new Map(Object.entries(ee).map(n=>n.reverse()))});var re=_(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.parseTokenizedReward=D.decodeAndInflate=void 0;var ge=K(),ye=Q();function te(n){let e=(0,ge.decodePayload)(n);return(0,ye.inflateRewardsToken)(e)}D.decodeAndInflate=te;function ve(n){if(!n?.token)return n;let e=te(n.token);switch(e.type){case"cut":{let r=he(e);e.type=r.type,e.amount=r.amount;break}case"forced-percentage":{e.type="percentage";break}case"threshold":{e.threshold=we(e);break}}return Object.assign(Object.assign({},n.clientData),{reward:e,token:n.token})}D.parseTokenizedReward=ve;function he(n){return n.categories[0]}function we(n){return n.tiers[0].spendCents}});var ne=_(O=>{"use strict";var _e=O&&O.__createBinding||(Object.create?function(n,e,r,t){t===void 0&&(t=r);var o=Object.getOwnPropertyDescriptor(e,r);(!o||("get"in o?!e.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(n,t,o)}:function(n,e,r,t){t===void 0&&(t=r),n[t]=e[r]}),W=O&&O.__exportStar||function(n,e){for(var r in n)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&_e(e,n,r)};Object.defineProperty(O,"__esModule",{value:!0});W(K(),O);W(Q(),O);W(re(),O)});var B=_(E=>{"use strict";var $=E&&E.__awaiter||function(n,e,r,t){function o(i){return i instanceof r?i:new r(function(a){a(i)})}return new(r||(r=Promise))(function(i,a){function c(s){try{u(t.next(s))}catch(d){a(d)}}function l(s){try{u(t.throw(s))}catch(d){a(d)}}function u(s){s.done?i(s.value):o(s.value).then(c,l)}u((t=t.apply(n,e||[])).next())})};Object.defineProperty(E,"__esModule",{value:!0});var Oe=new Set(["and","or","not","regex","listContains","equals","elementExists"]),Pe=new Set(["url","protocol","domain","path","search","cookie","userCountry","domContent"]),z=class{constructor({url:e,protocol:r,domain:t,pathname:o,search:i,country:a,getCookie:c}){Object.assign(this,{url:e,protocol:r,domain:t,pathname:o,search:i,country:a,getCookie:c}),this.testElementExistAttemptCount=0,this.elementExistsTimeoutMs=2e3}getContextValueForOperation(e){return $(this,void 0,void 0,function*(){let{context:r}=e;if(!Pe.has(r))throw new Error(`Unsupported context [${r}]`);if(r==="url")return this.url;if(r==="protocol")return this.protocol;if(r==="domain")return this.domain;if(r==="path")return this.pathname;if(r==="search")return this.search;if(r==="cookie")return this.getCookie(e.name);if(r==="userCountry")return this.country})}test(e,r=!1){return $(this,void 0,void 0,function*(){if(!Oe.has(e.operator))return console.error(`[programs] Unsupported operator [${e.operator}]`),!1;if(e.operator==="and"){if(!Array.isArray(e.value))throw new Error("The value of operator `and` must be an array");let t=!0;for(let o of e.value)if(!(yield this.test(o,r))){t=!1;break}return t}if(e.operator==="not"){if(Array.isArray(e.value))throw new Error("The value of operator `not` must be a single condition");return(yield this.test(e.value,r))===!1}if(e.operator==="or"){if(!Array.isArray(e.value))throw new Error("The value of operator `or` must be an array");let t=!1;for(let o of e.value)if(yield this.test(o,r)){t=!0;break}return t}if(e.operator==="regex"){let t=yield this.getContextValueForOperation(e);if(typeof t!="string")return!1;let o=e.value||e.pattern;return o&&!!t.match(new RegExp(o,e.flags||""))}if(e.operator==="listContains"){let t=yield this.getContextValueForOperation(e);return Array.isArray(e.value)&&e.value.includes(t)}if(e.operator==="equals"){let t=yield this.getContextValueForOperation(e);return e.value===t}if(e.operator==="elementExists"){if(!r)return!1;try{return yield this.testElementExists(e.value)}catch(t){return console.error("[programs] program rules error",t),null}}return!1})}hasDomContentRule(e){let r=!1,t=o=>{if(Array.isArray(o.value))for(let i of o.value)t(i);o.context==="domContent"&&(r=!0)};return t(e),r}testClientRules(e,r){return $(this,void 0,void 0,function*(){return r&&(this.elementExistsTimeoutMs=r),{matched:yield this.test(e,!0),elementExistTestCount:this.testElementExistAttemptCount}})}testElementExists(e){return $(this,void 0,void 0,function*(){let t=this.elementExistsTimeoutMs/100;return new Promise((o,i)=>{if(document.querySelectorAll(e).length>0)return o(!0);try{let c=0,l=setInterval(()=>{c++;let u=document.querySelectorAll(e);if(this.testElementExistAttemptCount++,u.length>0)return clearInterval(l),o(!0);if(c>=t)return clearInterval(l),o(!1)},100)}catch(c){return i(c)}})})}};E.default=z});var oe=_(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});function be(n=[]){let e=n.find(r=>r.indexOf("c_ranker_")===0);if(e)return e.split("c_ranker_")[1]}H.default=be});var X=_(G=>{"use strict";Object.defineProperty(G,"__esModule",{value:!0});var J=le(),Te=["1password.com","pantheonsite.io"];function Re(n){let e=J.getDomain(n);if(!e){let i=J.getPublicSuffix(n);if(Te.includes(i))return i}let r=J.getSubdomain(n),t=r&&r.startsWith("www.")?r.substr(4):r,o=`${t}.${e}`;return t&&t!=="www"?o:e}G.default=Re});var ue=_(P=>{"use strict";var I=P&&P.__awaiter||function(n,e,r,t){function o(i){return i instanceof r?i:new r(function(a){a(i)})}return new(r||(r=Promise))(function(i,a){function c(s){try{u(t.next(s))}catch(d){a(d)}}function l(s){try{u(t.throw(s))}catch(d){a(d)}}function u(s){s.done?i(s.value):o(s.value).then(c,l)}u((t=t.apply(n,e||[])).next())})};Object.defineProperty(P,"__esModule",{value:!0});P.getProgramDataById=P.applyClientRules=void 0;var je=ce(),F=de(),xe=ne(),Y=B(),Ce=oe(),ie=X(),se=globalThis.URL?globalThis.URL:je.URL;function ke(n,{apiBase:e,sessionToken:r,ignoreCache:t,experience:o,omitCredentials:i,onFetchError:a,fetchOptions:c}){var l;return I(this,void 0,void 0,function*(){let u=r?{"x-wb-session":decodeURIComponent(r)}:void 0,s=t?{"cache-control":"no-cache"}:void 0,d=Object.assign(Object.assign({},u),s),k=Object.assign(Object.assign({headers:d},{credentials:i?"omit":void 0}),c),g=yield(yield(0,F.memoizedFetch)(`${e}/v1/programs/${n}${o?`?experience=${o}`:""}`,k,a)).json();return(l=g?.programs)===null||l===void 0?void 0:l.rules})}function ae(n,{apiBase:e,sessionToken:r,features:t,extensionName:o,ignoreCache:i,vendorMetaId:a,destUrl:c,omitCredentials:l,onFetchError:u,fetchOptions:s,subExperience:d}){return I(this,void 0,void 0,function*(){let C=r?{"x-wb-session":decodeURIComponent(r)}:void 0,k=i?{"cache-control":"no-cache"}:void 0,y=a?{"vendor-meta-id":a}:void 0,g=Object.assign(Object.assign(Object.assign({},C),k),y),b=Object.assign(Object.assign({headers:g},{credentials:l?"omit":void 0}),s),x=(0,Ce.default)(t),T=`?${o?`extension=${o}`:""}${x?`&ranker=${x}`:""}`,R=t?.includes("rewards_engine_enabled"),q="";if(R){let h=new URLSearchParams;h.append("re","t"),c&&t?.includes("use_redirect_link_service")&&t?.includes("use_redirect_v_3")&&h.append("destUrl",c),d&&h.append("sxp",d),q=`?${h}`}let j=(0,F.memoizedFetch)(`${e}/v1/program/${n}/coupons${T}`,b,u).then(h=>h.json()),A=(0,F.memoizedFetch)(`${e}/v1/program/${n}/rewards${q}`,b,u).then(h=>h.json()),Z=(0,F.memoizedFetch)(`${e}/v1/program/${n}`,b,u).then(h=>h.json()),[v,f,w]=yield Promise.all([j,A,Z]);w.meta=Me(w?.meta,v?.meta);let N=R?(0,xe.parseTokenizedReward)(f?.rewards):f?.rewards,L=Object.assign(Object.assign({},w.siteData),{coupons:v?.coupons,cashback:N});return R&&f?.redirectUrl&&(L.cashback=Object.assign(Object.assign({},L.cashback),{redirectUrl:f.redirectUrl})),Object.assign(Object.assign({},w),{siteData:L})})}function Me(n={},e={}){return Object.assign(Object.assign({},n),e)}function Ae({url:n,session:e,getCookie:r,apiBase:t,extensionName:o,ignoreCache:i,experience:a,subExperience:c,platformDomain:l,vendorMetaId:u,omitCredentials:s,onFetchError:d,fetchOptions:C}){return I(this,void 0,void 0,function*(){let k=l||(0,ie.default)(n),{pathname:y,hostname:g,protocol:M,search:b}=new se(n),x=e.country;t=t||"https://capitaloneshopping.com/api";let T=yield ke(k,{apiBase:t,ignoreCache:i,sessionToken:e.sessionToken,features:e.features,extensionName:o,experience:a,omitCredentials:s,onFetchError:d,fetchOptions:C}),R=T.filter(v=>{let{rulesTree:f}=v;return!new Y.default({url:n,domain:g,pathname:y,protocol:M,search:b,country:x,getCookie:r}).hasDomContentRule(f)}),q=R.length<T.length,j;for(let v of R){let{programId:f,rulesTree:w}=v;if(yield new Y.default({url:n,domain:g,pathname:y,protocol:M,search:b,country:x,getCookie:r}).test(w)){j=f;break}}if(!j&&!T.length)return;let A;return j&&(A=yield ae(j,{apiBase:t,ignoreCache:i,sessionToken:e.sessionToken,features:e.features,extensionName:o,vendorMetaId:u,destUrl:n,omitCredentials:s,fetchOptions:C,subExperience:c})),{program:A,deferredProgramSelection:q?T:null}})}P.default=Ae;function De(n,e,r,t,o){return I(this,void 0,void 0,function*(){let i=(0,ie.default)(e),{pathname:a,protocol:c,search:l}=new se(e),u=(y,g)=>(y+=g.duration,y),s=[],d=0;for(let y of n){d++;let g=performance.now(),{programId:M,rulesTree:b}=y,x=new Y.default({url:e,protocol:c,domain:i,pathname:a,search:l,country:r,getCookie:t}),{matched:T,elementExistTestCount:R}=yield x.testClientRules(b,o?.programAttemptTimeoutMs),j=performance.now()-g;if(s.push({program:M,duration:j,attempts:R}),T){let A=s.reduce(u,0);return{programId:M,metrics:{totalDuration:A,programsTestedCount:d,attempts:s}}}}return{metrics:{totalDuration:s.reduce(u,0),programsTestedCount:d,attempts:s}}})}P.applyClientRules=De;function qe(n,{url:e,session:r,apiBase:t,extensionName:o,ignoreCache:i,vendorMetaId:a,omitCredentials:c,fetchOptions:l,subExperience:u}){return I(this,void 0,void 0,function*(){return t=t||"https://capitaloneshopping.com/api",yield ae(n,{apiBase:t,ignoreCache:i,sessionToken:r.sessionToken,features:r.features,extensionName:o,vendorMetaId:a,destUrl:e,omitCredentials:c,fetchOptions:l,subExperience:u})})}P.getProgramDataById=qe});var Ie=_(p=>{"use strict";Object.defineProperty(p,"__esModule",{value:!0});p.getSiteDomainFromUrl=p.ProgramRules=p.applyClientRules=p.getProgramDataById=p.getProgram=void 0;var V=ue();p.getProgram=V.default;Object.defineProperty(p,"getProgramDataById",{enumerable:!0,get:function(){return V.getProgramDataById}});Object.defineProperty(p,"applyClientRules",{enumerable:!0,get:function(){return V.applyClientRules}});var Se=B();p.ProgramRules=Se.default;var Ee=X();p.getSiteDomainFromUrl=Ee.default;p.default=V.default});export{ne as a,Ie as b};
