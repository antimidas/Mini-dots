(function(){"use strict";if(window.onerror=function(e,t,n,s,i){return console.group(`%c ATBE ERROR (${new Date().toLocaleTimeString()}) \u26A0 `,"color: yellow; background: red;"),console.error(i),console.groupEnd(),!0},!ExtAutoInject.pageMatches)return;const De=document.documentElement,a=new ExtStorageManager(null,ut);new ExtAutoInject().then(me);const Ie={playbackFailedTimes:0,fetchFailedTimes:0,beforeCheckTime:1/0},Ne={videoElement:null,playerActive:!1,playerFit:!1,pageUrl:location.href,prevUrl:null,integrityFailed:0},W=[],se=[],qe=ee(10),lt=w();let ae=null,oe=null,V=null,Ce=null,dt=null,re=null,ce=null,le=null,de=null,O=null,ue=null,D=!1,x=null,F=null,U=null,R=null,Re=0,T=J(Ie),d=J(Ne);Ge(()=>{try{let e=!1;const t=arguments[0],n=i=>{let o=100;const r=i.data.autoTwitchBrowserExtensionIntegrity,c=i.data.autoTwitchBrowserExtensionShutdown,l=()=>{if(o--){if("KPSDK"in window&&!KPSDK.isReady()){setTimeout(l,100);return}fetch("https://gql.twitch.tv/integrity",{method:"post",headers:r})}};i.source===window&&(r?l():c===t&&(window.removeEventListener("message",n),e=!0))};window.addEventListener("message",n),window._originalFetch=window._originalFetch||fetch,window.fetch=new Proxy(fetch,{apply:(i,o,r)=>{if(!e&&r&&typeof r[0]=="string"&&r[0].match(/^https:\/\/gql\.twitch\.tv\/gql/)){const l=r[1]&&r[1].body&&JSON.parse(r[1].body)||null;l&&l.operationName==="PlaybackAccessToken"&&["embed","popout"].includes(l.variables.playerType)&&(l.variables.playerType="site",r[1].body=JSON.stringify(l))}const c=i.apply(o,r);return c.then(l=>{e||(l.url==="https://gql.twitch.tv/gql"&&l.clone().json().then(u=>{try{u.some(m=>{if(m.extensions.operationName==="ChannelPointsContext"){const S=m.data.community.channel.self.communityPoints.availableClaim;return S&&window.postMessage({autoTwitchBrowserExtension:{claimID:S.id,channelID:m.data.community.channel.id}},"*"),!0}if(m.extensions.operationName==="DropCurrentSessionContext")return m.data.currentUser.dropCurrentSession.currentMinutesWatched===m.data.currentUser.dropCurrentSession.requiredMinutesWatched&&window.postMessage({autoTwitchBrowserExtension:{drop:!0}},"*"),!0})}catch{}}),l.url==="https://gql.twitch.tv/integrity"&&l.clone().json().then(u=>{try{u&&u.token&&window.postMessage({autoTwitchBrowserExtension:{integrity:u}},"*")}catch{}}))}).catch(l=>{throw(l.message=/hls\.ttvnw\.net|gql\.twitch\.tv/.test(r[0]))&&window.postMessage({autoTwitchBrowserExtension:{fetchFailed:!0}},"*"),l}),c}}),window._originalWebSocket=window._originalWebSocket||WebSocket,window.WebSocket=new Proxy(_originalWebSocket,{construct:(i,o)=>{const r=new i(...o);try{r.addEventListener("message",c=>{if(c.target.url!=="wss://pubsub-edge.twitch.tv/v1")return;const l=JSON.parse(c.data);if(l.type==="MESSAGE"){if(l.data.topic.match(/^community-points-user-v1/)){const u=JSON.parse(l.data.message);if(u.type!=="claim-available")return;const m=u.data.claim;m&&window.postMessage({autoTwitchBrowserExtension:{claimID:m.id,channelID:m.channel_id}},"*");return}if(l.data.topic.match(/^user-drop-events/)){const u=JSON.parse(l.data.message);if(u.type!=="drop-progress")return;u.data.current_progress_min&&u.data.current_progress_min===u.data.required_progress_min&&setTimeout(()=>window.postMessage({autoTwitchBrowserExtension:{drop:!0}},"*"),1200);return}if(l.data.topic.match(/^onsite-notifications/)){const u=JSON.parse(l.data.message);if(u.type!=="create-notification")return;u.data.notification.type==="user_drop_reward_reminder_notification"&&window.postMessage({autoTwitchBrowserExtension:{drop:!0}},"*");return}if(l.data.topic.match(/^community-moments-channel/)){const u=JSON.parse(l.data.message);if(u.type!=="active")return;const m=u.data;window.postMessage({autoTwitchBrowserExtension:{momentID:m.moment_id,channelID:m.channel_id,clipSlug:m.clip_slug}},"*")}if(l.data.topic.match(/^predictions-channel-v1/)){const u=JSON.parse(l.data.message);if(!["event-created","event-updated"].includes(u.type))return;const m=u.data.event;m&&m.status==="ACTIVE"&&window.postMessage({autoTwitchBrowserExtension:{predictionActive:m}},"*")}if(l.data.topic.match(/^predictions-user-v1/)){const u=JSON.parse(l.data.message);if(u.type!=="prediction-result")return;const m=u.data.prediction;m&&window.postMessage({autoTwitchBrowserExtension:{predictionResult:m}},"*")}}})}catch{}try{let c=null;r.addEventListener("open",l=>{if(l.target.url!=="wss://pubsub-edge.twitch.tv/v1")return;const u=()=>Math.random().toString(36).substr(2,10).repeat(3),m=()=>{c=document.cookie.match(/(?:^|; )twilight-user=([^;]*)/),c=c&&JSON.parse(decodeURIComponent(c[1]))},S=new URL(location.href).searchParams.get("channel");m(),setInterval(()=>{m(),c&&(r.send(`{"type":"LISTEN","nonce":"${u()}","data":{"topics":["community-points-user-v1.${c.id}"],"auth_token":"${c.authToken}"}}`),r.send(`{"type":"LISTEN","nonce":"${u()}","data":{"topics":["user-drop-events.${c.id}"],"auth_token":"${c.authToken}"}}`),r.send(`{"type":"LISTEN","nonce":"${u()}","data":{"topics":["onsite-notifications.${c.id}"],"auth_token":"${c.authToken}"}}`),r.send(`{"type":"LISTEN","nonce":"${u()}","data":{"topics":["predictions-user-v1.${c.id}"],"auth_token":"${c.authToken}"}}`))},2*60*1e3),location.hostname==="player.twitch.tv"&&c&&fetch("https://gql.twitch.tv/gql",{method:"post",headers:{Authorization:`OAuth ${c.authToken}`},body:JSON.stringify([{operationName:"FollowButton_User",extensions:{persistedQuery:{sha256Hash:"870906a2de25d7488239dbeb947dafe3e5697f1fef2e8bce6601555a17e4d86d",version:1}},variables:{login:S}}])}).then(h=>h.json()).then(h=>{try{if(h&&h[0]&&h[0].errors&&h[0].errors[0])throw new Error(`ERROR: ${h[0].errors[0].message}`);const _=h[0].data.user.id;r.send(`{"type":"LISTEN","nonce":"${u()}","data":{"topics":["community-points-user-v1.${c.id}"],"auth_token":"${c.authToken}"}}`),r.send(`{"type":"LISTEN","nonce":"${u()}","data":{"topics":["user-drop-events.${c.id}"],"auth_token":"${c.authToken}"}}`),r.send(`{"type":"LISTEN","nonce":"${u()}","data":{"topics":["onsite-notifications.${c.id}"],"auth_token":"${c.authToken}"}}`),r.send(`{"type":"LISTEN","nonce":"${u()}","data":{"topics":["predictions-user-v1.${c.id}"],"auth_token":"${c.authToken}"}}`),r.send(`{"type":"LISTEN","nonce":"${u()}","data":{"topics":["community-moments-channel-v1.${_}"],"auth_token":"${c.authToken}"}}`),r.send(`{"type":"LISTEN","nonce":"${u()}","data":{"topics":["predictions-channel-v1.${_}"],"auth_token":"${c.authToken}"}}`)}catch{}}).catch(h=>{throw h})})}catch{}return r}});const s={apply:(i,o,r)=>{const c=i.apply(o,r);return window.postMessage({autoTwitchBrowserExtension:{historyUpdated:!0}},"*"),c}};window._originalHistory=window._originalHistory||history,window.history.pushState=new Proxy(_originalHistory.pushState,s),window.history.replaceState=new Proxy(_originalHistory.replaceState,s),document.documentElement.classList.add("_ATBE_INTER_")}catch(e){console.group("%c ATBE ERROR \u26A0 ","color: yellow; background: red;"),console.error(e),console.groupEnd()}}),Dt();function ut(e){a.onUpdate("settings.enabled",t=>{t?Me():Oe()}).onUpdate("settings.changeIcon",t=>{t&&a.get("settings.enabled")?K(d.playerActive&&!ve()):K()}).onUpdate("settings.hideExtensions",Z).onUpdate("settings.showPreviews",Te).onUpdate("settings.clickPause",Y).onUpdate("settings.claimPoints",t=>{t&&pe()}).onUpdate("settings.claimDrops",t=>{t&&Q()}).onUpdate("processExtensionReload",t=>{t&&me()}),e.settings.enabled&&Me(),chrome.runtime.sendMessage("registerTab"),window.addEventListener("beforeunload",()=>{!D&&chrome.runtime.sendMessage("unregisterTab")}),chrome.runtime.onMessage.addListener(Fe),Ze()}function Me(){if(window.addEventListener("message",xe),window.addEventListener("popstate",be),Ke(),vt(),Xe(),Z(),Te(),Y(),document.readyState!=="complete"){He(!0),Je(!0);return}De.classList.contains("_ATBE_INTER_")?(pe(),Q()):X()}function Oe(){window.removeEventListener("message",xe),window.removeEventListener("popstate",be),clearTimeout(ae),clearTimeout(oe),clearTimeout(V),clearTimeout(ce),clearTimeout(le),clearTimeout(de),clearTimeout(dt),clearTimeout(re),Z(),Te(),Y(),C(),fe(),he(),T=J(Ie),d=J(Ne),Pt(),K()}function me(){window.postMessage({autoTwitchBrowserExtensionShutdown:qe},"*"),D=!0,clearTimeout(Ce),Oe(),chrome.runtime.onMessage.removeListener(Fe),a.offUpdate()}function xe(e){const t=e.data.autoTwitchBrowserExtension;e.source!==window||!t||setTimeout(()=>{if(t.claimID)return Ue(t);if(t.drop)return Q();if(t.momentID)return gt(t);if(t.fetchFailed)return Qe();if(t.historyUpdated)return be();if(t.predictionActive)return At(t.predictionActive);if(t.predictionResult)return $t(t.predictionResult);if(t.integrity){R=t.integrity;return}},document.readyState==="complete"?1e3:3e3)}function Fe(e){e.visualAlert?ht(e.visualAlert):e.visualAlertClose?ft(e.visualAlertClose):e.delayedReload&&ze(e.delayedReload)}function pe(){!a.get("settings.enabled")||!a.get("settings.claimPoints")||(_e()&&k().then(e=>{fetch("https://gql.twitch.tv/gql",{method:"post",headers:e,body:JSON.stringify([{operationName:"ChannelPointsContext",extensions:{persistedQuery:{sha256Hash:"374314de591e69925fce3ddc2bcf085796f56ebb8cad67a0daa3165c03adc345",version:1}},variables:{channelLogin:we(),includeGoalTypes:["CREATOR"]}}])}).then(t=>t.json()).then(t=>{try{if(L(t,"checkPoints")||!t[0]||!t[0].data||!t[0].data.community)return;const n=t[0].data.community.channel.self.communityPoints.availableClaim;n&&Ue({claimID:n.id,channelID:t[0].data.community.channel.id})}catch(n){f(n,"checkPoints")}}).catch(t=>{throw t})}).catch(e=>{f(e,"checkPoints")}),He())}function Q(){!a.get("settings.enabled")||!a.get("settings.claimDrops")||(k().then(e=>{fetch("https://gql.twitch.tv/gql",{method:"post",headers:e,body:JSON.stringify([{operationName:"Inventory",extensions:{persistedQuery:{sha256Hash:"09acb7d3d7e605a92bdfdcc465f6aa481b71c234d8686a9ba38ea5ed51507592",version:1}},variables:{fetchRewardCampaigns:!1}}])}).then(t=>t.json()).then(t=>{try{if(L(t,"checkDrops"))return;const n=[];t[0]&&t[0].data&&t[0].data.currentUser.inventory&&t[0].data.currentUser.inventory.dropCampaignsInProgress&&t[0].data.currentUser.inventory.dropCampaignsInProgress.forEach(s=>{s.timeBasedDrops.forEach(i=>{if(i.self.dropInstanceID&&!i.self.isClaimed&&i.benefitEdges.length){const o=JSON.parse(JSON.stringify(i.benefitEdges)),r=JSON.parse(JSON.stringify(i));r.type="drops",r.dropInstanceID=i.self.dropInstanceID,r.game=JSON.parse(JSON.stringify(s.game)),delete r.benefitEdges,delete r.self,delete r.__typename,delete r.campaign.self,delete r.campaign.__typename,delete r.game.__typename,o.forEach(c=>{const l=JSON.parse(JSON.stringify(r));l.benefit=JSON.parse(JSON.stringify(c)),l.benefit.imageAssetURL=c.benefit.imageAssetURL,l.benefit.name=c.benefit.name,delete l.benefit.benefit,delete l.benefit.__typename,n.push(l)}),mt(i.self.dropInstanceID,n)}})})}catch(n){f(n,"checkDrops")}}).catch(t=>{throw t})}).catch(e=>{f(e,"checkDrops")}),Je())}function Ue(e){a.get("settings.claimPoints")&&k().then(t=>{fetch("https://gql.twitch.tv/gql",{method:"post",headers:t,body:JSON.stringify([{operationName:"ClaimCommunityPoints",extensions:{persistedQuery:{sha256Hash:"46aaeebe02c99afdf4fc97c7c0cba964124bf6b0af229395f1f6d1feed05b3d0",version:1}},variables:{input:e}}])}).then(n=>n.json()).then(n=>{try{if(L(n,"claimPoints")||!n[0].data.claimCommunityPoints.claim)return;const s=n[0].data.claimCommunityPoints.claim.pointsEarnedTotal;if(!s)return;pt(e.channelID,i=>{const o=a.get("statistics.totalPoints"),r=a.get("lastPoints");r.unshift(Object.assign(i,{type:"points",claimedAt:w(),channelID:e.channelID,claimID:e.claimID,points:s})),I("lastPoints",r),a.set("statistics.totalPoints",(o||0)+s),chrome.runtime.sendMessage({analytics:{name:"claim",params:{kind:"points",value:s}}})})}catch(s){f(s,"claimPoints")}}).catch(n=>{throw n})}).catch(t=>{f(t,"claimPoints")})}function mt(e,t){a.get("settings.claimDrops")&&k().then(n=>{fetch("https://gql.twitch.tv/gql",{method:"post",headers:n,body:JSON.stringify([{operationName:"DropsPage_ClaimDropRewards",extensions:{persistedQuery:{sha256Hash:"a455deea71bdc9015b78eb49f4acfbce8baa7ccbedd28e549bb025bd0f751930",version:1}},variables:{input:{dropInstanceID:e}}}])}).then(s=>s.json()).then(s=>{try{if(L(s,"claimDrops")||!s[0].data.claimDropRewards)return;const i=a.get("lastDrops");if(i.some(l=>{if(l.dropInstanceID===e)return!0}))return;const r=a.get("statistics.totalDrops"),c=w();t.forEach(l=>{l.claimedAt=c,i.unshift(l)}),I("lastDrops",i),a.set("statistics.totalDrops",(r||0)+t.length),chrome.runtime.sendMessage({analytics:{name:"claim",params:{kind:"drops",value:t.length}}})}catch(i){f(i,"claimDrops")}}).catch(s=>{throw s})}).catch(n=>{f(n,"claimDrops")})}function pt(e,t){const n={image:null,pointsName:null,displayName:null},s=(i,o)=>{fetch("https://gql.twitch.tv/gql",{method:"post",headers:o,body:JSON.stringify([{operationName:"ChannelPointsContext",extensions:{persistedQuery:{sha256Hash:"374314de591e69925fce3ddc2bcf085796f56ebb8cad67a0daa3165c03adc345",version:1}},variables:{channelLogin:i,includeGoalTypes:["CREATOR"]}}])}).then(r=>r.json()).then(r=>{if(L(r,"getPointsSettings")){t(n);return}const c=r[0].data.community.channel.communityPointsSettings,l=r[0].data.community.displayName;if(!c||!l){t(n);return}t({image:c.image&&c.image.url4x||null,pointsName:c.name,login:i,displayName:l})}).catch(()=>{t(n)})};k().then(i=>{Ee(e).then(o=>{s(o,i)}).catch(()=>{t(n)})}).catch(i=>{t(n),f(i,"getPointsSettings")})}function gt(e){if(!a.get("settings.claimMoments"))return;const t=n=>{fetch("https://gql.twitch.tv/gql",{method:"post",headers:n,body:JSON.stringify([{operationName:"WatchLivePrompt",extensions:{persistedQuery:{sha256Hash:"dcf741d88e5066ac8c140f1247309c36ce459b9c15a1ef726634081733d7147d",version:1}},variables:{slug:e.clipSlug}},{operationName:"ClipsTitle",extensions:{persistedQuery:{sha256Hash:"f6cca7f2fdfbfc2cecea0c88452500dae569191e58a265f97711f8f2a838f5b4",version:1}},variables:{slug:e.clipSlug}}])}).then(s=>s.json()).then(s=>{try{if(L(s,"claimMoment"))return;const i=a.get("statistics.totalMoments"),o=a.get("lastMoments"),r=s[0].data.clip;delete r.__typename,delete r.broadcaster.__typename,delete r.broadcaster.stream.__typename,delete r.broadcaster.stream.game.__typename,o.unshift(Object.assign(r,{type:"moments",claimedAt:w(),momentID:e.momentID,slug:e.clipSlug,title:s[1].data&&s[1].data.clip&&s[1].data.clip.title||null})),I("lastMoments",o),a.set("statistics.totalMoments",(i||0)+1),chrome.runtime.sendMessage({analytics:{name:"claim",params:{kind:"moments",value:1}}})}catch(i){f(i,"claimMoment")}}).catch(s=>{throw s})};k().then(n=>{fetch("https://gql.twitch.tv/gql",{method:"post",headers:n,body:JSON.stringify([{operationName:"CommunityMomentCallout_Claim",extensions:{persistedQuery:{sha256Hash:"e2d67415aead910f7f9ceb45a77b750a1e1d9622c936d832328a0689e054db62",version:1}},variables:{input:{momentID:e.momentID}}}])}).then(s=>s.json()).then(s=>{try{if(L(s,"claimMoment")||!s[0].data.claimCommunityMoment.moment)return;t(n)}catch(i){f(i,"claimMoment")}}).catch(s=>{throw s})}).catch(n=>{f(n,"claimMoment")})}function He(e){clearTimeout(ae),a.get("settings.claimPoints")&&(ae=setTimeout(pe,a.get(`config.${e?"reloadDelay":"checkPointsDelay"}`)))}function Je(e){clearTimeout(oe),a.get("settings.claimDrops")&&(oe=setTimeout(Q,a.get(`config.${e?"reloadDelay":"checkDropsDelay"}`)))}function ht(e){const t=We();if(!t)return;let n="",s=document.createElement("div");const i=e.item,o=i.type,r=`${o}:${i.claimID||i.dropInstanceID||i.momentID||i.id||0}`,c=e.duration||5,l=["raids","predictions","reloads"].includes(o),u=["points","moments","raids","predictions"].includes(o),m=["reloads"].includes(o),S=E("/icon/appicon_16.png"),h=E("/img/close-icon.svg"),_=E("/img/cancel-icon.svg"),v=E("/img/open-icon.svg"),ne=E("/img/robot-icon.svg"),Mt=E("/img/help-icon.svg"),Ot=E("/img/open-popup-icon.svg"),xt=E("/img/setting-disable-icon.svg"),Ae=E("/img/done-icon.svg"),ie=A=>{s&&(s.classList.add("_ATBE_alerts-item_hide"),!D&&A&&chrome.runtime.sendMessage({resend:{visualAlertClose:r}}),setTimeout(()=>{s&&s.remove(),s=null},a.get("config.transitionDelay")))};l?(()=>{const A=a.get("config.luckyFactorPredict"),b="https://www.twitch.tv/",y=i.status,g=i.data,B=o==="predictions"?y===0?"predictionsStart":"predictionsResult":o,N=je(B),M=o==="raids"&&p("alert_raids")||o==="predictions"&&p(y===0?"alert_predictionsStart":"alert_predictionsResult")||o==="reloads"&&p("alert_reloads")||p("stat_unknown"),$e=o==="raids"&&p("alert_raidsDescr")||o==="predictions"&&p(y===0?"alert_predictionsDescrStart":y===1?"alert_predictionsDescrWin":y===2?"alert_predictionsDescrLose":"alert_predictionsDescrRefund")||o==="reloads"&&p("alert_reloadsDescr")||"",q=o==="raids"&&`${b}${g.to.login}`||o==="predictions"&&(g.login?Se(g.login):b)||o==="reloads"&&g.page||"",ke=o==="raids"&&g.to.displayName||o==="predictions"&&(y===0?g.title:`${y===1?g.pointsWon:g.points} ${p("alert_pointsVar")}`)||o==="reloads"&&Ct(g.page)||p("stat_unknown"),Le=["raids","predictions"].includes(o)&&`${b}${g.login||""}`||"",Ft=["raids","predictions"].includes(o)&&g.displayName||p("stat_unknown"),ct=g.pointsWon&&(g.pointsWon/g.points).toFixed(1),Be=["playbackError","integrityFail"].includes(g.reloadType),Ut=o==="predictions"&&y===0&&p("alert_predictionsDescrOutcomes")||o==="reloads"&&p("alert_reloadsDescrReason")||"";let j="";Array.isArray(g.outcomes)?g.outcomes.forEach((Pe,Ht)=>{Ht&&(j+=", "),j+=`<b class="_ATBE_color _ATBE_color_${Pe.color&&Pe.color.toLowerCase()}">${Pe.title}</b>`}):g.hasOwnProperty("reloadType")&&(j=`<b class="_ATBE_color _ATBE_color_warn">${Be&&p(`alert_reloadsDescr${Rt(g.reloadType)}`)||p("stat_unknown")}</b>`),n+='<div class="_ATBE_alerts-item__header">',n+=`<span class="_ATBE_alerts-item__title" style="--ATBE-bg-img:url(${S})">${M}</span>`,n+=`<button class="_ATBE_alerts-item__cancel" style="--ATBE-bg-img:url(${_})"></button>`,n+=`<button class="_ATBE_alerts-item__close" style="--ATBE-bg-img:url(${h})"></button></div>`,n+=`<div class="_ATBE_alerts-item__body"><span class="_ATBE_alerts-item__descr">${$e}</span>`,q&&(n+=`&nbsp;<a class="_ATBE_alerts-item__link" target="_blank" rel="noreferrer" href="${q}">${ke}<span class="_ATBE_alerts-item__link-icon" style="--ATBE-bg-img:url(${v})"></span></a>`),j&&(n+=`<div class="_ATBE_alerts-item__descr2">${Ut} ${j}</div>`),o==="predictions"&&y===1&&(n+=`<div class="_ATBE_alerts-item__descr2">${p("alert_winFactor")} <b class="_ATBE_color">x${ct}</b></div>`),o==="predictions"&&y===0&&g.login&&g.displayName&&(n+=`<button class="_ATBE_alerts-item__btn" data-param="${g.login}" data-param2="${g.displayName}" data-type="predict" style="--ATBE-icon-img:url(${Ot});--ATBE-icon-done-img:url(${Ae})">${p("alert_openPrediction")}</button>`),o==="reloads"&&Be&&(n+=`<button class="_ATBE_alerts-item__btn _ATBE_alerts-item__btn_setting" data-param="${g.reloadType}" data-type="disable" style="--ATBE-icon-img:url(${xt});--ATBE-icon-done-img:url(${Ae})">${p("alert_reloadDisable")}</button>`),o==="reloads"&&Be&&(n+=`<button class="_ATBE_alerts-item__btn _ATBE_alerts-item__btn_help" data-param="${g.reloadType==="playbackError"&&"errors_playback"||g.reloadType==="integrityFail"&&"errors_integrity"||""}" data-type="help" style="--ATBE-icon-img:url(${Mt});--ATBE-icon-done-img:url(${Ae})">${p("alert_learnMore")}</button>`),o==="predictions"&&y===1&&ct>=A&&(n+=`<div class="_ATBE_alerts-item__warn">${p("alert_criticalLuck")}</div>`),o==="raids"&&g.canceled&&(n+=`<div class="_ATBE_alerts-item__warn">${p("alert_raidsCanceled")}</div>`),n+=`</div><div class="_ATBE_alerts-item__timer" style="--ATBE-duration:${c}s" data-time="${w()}"></div>`,m?n+=`<div class="_ATBE_alerts-item__footer _ATBE_alerts-item__footer_automation" style="--ATBE-bg-img:url(${ne})"><i>${p("alert_extAutomation")}</i></div>`:(n+=`<a class="_ATBE_alerts-item__footer" target="_blank" rel="noreferrer" href="${Le}">${u&&p("alert_forChannel")||""} `,n+=`<b>${Ft}</b><span class="_ATBE_alerts-item__footer-icon" style="--ATBE-bg-img:url(${v})"></span></a>`),n+=`<div class="_ATBE_alerts-item__settings${N?" _ATBE_alerts-item__settings_active":""}"><button class="_ATBE_alerts-item__btn-disable-all">${p("alert_disableAll")}</button><button class="_ATBE_alerts-item__btn-disable-this" data-type="${B}">${p("alert_disableThis")}</button></div>`,s.classList.add("_ATBE_alerts-item_event")})():(()=>{const A=a.get("config.dropsTag"),b=a.get("config.hashDrop"),y="https://www.twitch.tv/",g=je(o),B=i.benefit&&i.benefit.imageAssetURL||i.image||i.thumbnailURL||E(`/img/${o}-icon.svg`),N=i.benefit&&i.benefit.name||o==="points"&&(i.pointsName||p("alert_pointsVar"))||o==="moments"&&i.title||p("stat_unknown"),M=o==="drops"&&`${p("alert_drop")} ${p("alert_claimedOne")}`||o==="moments"&&`${p("alert_moment")} ${p("alert_claimedOne")}`||o==="points"&&`${i.points||"?"} ${p("alert_points")} ${p("alert_claimedMany")}`||p("stat_unknown"),$e=i.game&&i.game.name||i.displayName||i.broadcaster&&i.broadcaster.displayName||null,q=encodeURIComponent(i.game&&i.game.name||i.login||i.broadcaster&&i.broadcaster.login||""),ke=o==="drops"&&(i.game&&i.game.slug?`directory/category/${i.game.slug}?${A}`:`directory/game/${q}?${A}`)||o==="points"&&q||o==="moments"&&q||"",Le=o==="drops"&&`${y}drops/inventory${b}${encodeURIComponent(N)}`||o==="points"&&(q?Se(q):y)||o==="moments"&&`https://clips.twitch.tv/${i.slug||""}`||"";n+='<div class="_ATBE_alerts-item__header">',n+=`<span class="_ATBE_alerts-item__title" style="--ATBE-bg-img:url(${S})">${M}</span>`,n+=`<button class="_ATBE_alerts-item__cancel" style="--ATBE-bg-img:url(${_})"></button>`,n+=`<button class="_ATBE_alerts-item__close" style="--ATBE-bg-img:url(${h})"></button></div>`,n+=`<a class="_ATBE_alerts-item__body" target="_blank" rel="noreferrer" href="${Le}">`,n+=`<span class="_ATBE_alerts-item__body-icon" style="--ATBE-bg-img:url(${v})"></span><img class="_ATBE_alerts-item__img" src="${B}" alt="${N}" data-type="${o}"/>`,o==="points"&&(n+=`<div class="_ATBE_alerts-item__modifier">&#215;${i.points||"?"}</div>`),n+=`<div class="_ATBE_alerts-item__name">${N}</div></a><div class="_ATBE_alerts-item__timer" style="--ATBE-duration:${c}s" data-time="${w()}"></div>`,n+=`<a class="_ATBE_alerts-item__footer" target="_blank" rel="noreferrer" href="${y}${ke}">`,n+=`${o==="drops"&&p("alert_forGame")||u&&p("alert_forChannel")||""} `,n+=`<b>${$e||p("stat_unknown")}</b>`,n+=`<span class="_ATBE_alerts-item__footer-icon" style="--ATBE-bg-img:url(${v})"></span></a>`,n+=`<div class="_ATBE_alerts-item__settings${g?" _ATBE_alerts-item__settings_active":""}"><button class="_ATBE_alerts-item__btn-disable-all">${p("alert_disableAll")}</button><button class="_ATBE_alerts-item__btn-disable-this" data-type="${o}">${p("alert_disableThis")}</button></div>`,s.classList.add("_ATBE_alerts-item_claim")})(),s.classList.add("_ATBE_alerts-item"),s.classList.add(`_ATBE_alerts-item_${o}`),s.dataset.id=r,s.innerHTML=n;const tt=s.querySelector("._ATBE_alerts-item__close");tt&&tt.addEventListener("click",ie);const nt=s.querySelector("._ATBE_alerts-item__cancel"),it=s.querySelector("._ATBE_alerts-item__settings");nt&&nt.addEventListener("click",()=>{it&&it.classList.toggle("_ATBE_alerts-item__settings_active")});const st=s.querySelector("._ATBE_alerts-item__btn-disable-all");st&&st.addEventListener("click",()=>{const A=a.get("settings.alerts");Object.keys(A).forEach(b=>{ge(`alerts.${b}.visual`)}),document.querySelectorAll("._ATBE_alerts-item__close").forEach(b=>b.click()),chrome.runtime.sendMessage({analytics:{name:"alert_setting",params:{kind:"alerts.[*].visual",value:!1}}})});const at=s.querySelector("._ATBE_alerts-item__btn-disable-this");at&&at.addEventListener("click",A=>{const y=`alerts.${A.target.dataset.type}.visual`;ge(y),ie(!0),chrome.runtime.sendMessage({analytics:{name:"alert_setting",params:{kind:y,value:!1}}})});const ot=s.querySelectorAll("._ATBE_alerts-item__btn");ot&&et(ot,"click",A=>{const b=A.target,y=b.dataset,g=y.type,B=y.param,N=()=>{b.disabled=!0,b.classList.add("_ATBE_alerts-item__btn_done")};if(B){if(g==="help")It(B),chrome.runtime.sendMessage({analytics:{name:"alert_open",params:{page:"Help"}}});else if(g==="predict")N(),ie(!0),yt(B,y.param2),chrome.runtime.sendMessage({analytics:{name:"alert_open",params:{page:"Prediction"}}});else if(g==="disable"){N();const M={playbackError:"autoReload",integrityFail:"integrityReload"};ge(M[B]),chrome.runtime.sendMessage({analytics:{name:"alert_setting",params:{kind:`settings.${M[B]}`,value:!1}}})}}});const rt=s.querySelectorAll("._ATBE_alerts-item__img");rt&&et(rt,"error",A=>{const b=A.target,y=b.dataset;b.src=E(`/img/${y.type}-icon.svg`)}),t.prepend(s),setTimeout(()=>{s&&s.classList.add("_ATBE_alerts-item_show"),setTimeout(ie,c*1e3)},0)}function je(e){const t=a.get("state.visualAlertsShown");return t.includes(e)?!1:(setTimeout(()=>{t.push(e),a.set("state.visualAlertsShown",t)},a.get("config.defaultDelay")),!0)}function ge(e){e&&a.set(`settings.${e}`,!1)}function ft(e){const t=document.querySelector(`._ATBE_alerts-item[data-id="${e}"]`);t&&(t.classList.add("_ATBE_alerts-item_hide"),setTimeout(()=>{t&&t.remove()},a.get("config.transitionDelay")))}function yt(e,t){const n=We();if(!n||!e)return;const s=E("/icon/appicon_16.png"),i=E("/img/close-icon.svg"),o=t?` ${p("alert_forChannel").toLowerCase()} ${t}`:"",r=Se(e,!0);let c=document.createElement("div"),l=`<div class="_ATBE_alerts-item__header"><span class="_ATBE_alerts-item__title" style="--ATBE-bg-img:url(${s})">${p("alert_predictionsVar")}${o}</span>`;l+=`<button class="_ATBE_alerts-item__close" style="--ATBE-bg-img:url(${i})"></button></div>`,l+=`<div class="_ATBE_alerts-item__overlay"><iframe class="_ATBE_alerts-item__iframe" src="${r}" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox" allow="encrypted-media *"/></div>`,c.classList.add("_ATBE_alerts-item"),c.classList.add("_ATBE_alerts-item_overlay"),c.innerHTML=l,c.querySelector("._ATBE_alerts-item__close").addEventListener("click",()=>{c.classList.add("_ATBE_alerts-item_hide"),setTimeout(()=>{c&&c.remove(),c=null},a.get("config.transitionDelay"))}),n.prepend(c),setTimeout(()=>{c.classList.add("_ATBE_alerts-item_show")},0),chrome.runtime.sendMessage({analytics:{name:"page_view",params:{page_title:"Prediction_Popup",page_location:"/twitch/prediction-popup"}}})}function We(){let e=document.querySelector("._ATBE_alerts");if(!e){const t=document.querySelector(a.get("config.querySelectors.playerContainer"))||document.querySelector(a.get("config.querySelectors.mainContainer"));if(!t)return null;e=document.createElement("div"),e.classList.add("_ATBE_alerts"),t.append(e)}return Ve(e),e}function Ve(e){const t=document.querySelector(a.get("config.querySelectors.playerEvents"));he(),!(!e||!t)&&(U=new ResizeObserver(()=>{if(!e||!t||!t.offsetTop&&!t.offsetHeight)return he();const n=t.offsetHeight?12:0;e.style.top=`${t.offsetTop+t.offsetHeight+n}px`,e.style.maxHeight=`calc(100% - ${t.offsetTop+t.offsetHeight+50+n}px)`}),U.observe(t))}function he(){U&&U.disconnect(),U=null;const e=document.querySelector("._ATBE_alerts");e&&(e.style.top=null,e.style.maxHeight=null)}function I(e,t){const n=a.get(`config.${e}Maxlength`);t.length>n&&(t=t.slice(0,n)),a.set(e,t,s=>{s==="QUOTA_BYTES_PER_ITEM quota exceeded"&&(t.pop(),I(e,t))})}function P(e){if(e){_t(),T.beforeCheckTime=w(),clearTimeout(V),V=setTimeout(P,e);return}const t=document.querySelector(a.get("config.querySelectors.playerElement")),n=()=>{if(!a.get("settings.autoReload")||!Ye("config.reloadErrorDelay")){P(a.get("config.playerHealthDelay"));return}const o=Math.round((i-a.get("config.playerHealthDelayMax"))/1e3),r=J(T);r.reloadTimeout=o>0?o:0,delete r.beforeCheckTime,f(new Error(`RELOAD: ${JSON.stringify(r)}`),"checkPlayerHealth"),X("playbackError")},s=()=>(T.playbackFailedTimes++,T.playbackFailedTimes>=a.get("config.playbackFailedMax")?n():P(a.get("config.waitPlayerError"))),i=w()-T.beforeCheckTime;if(clearTimeout(V),!d.playerFit||!t||!a.get("settings.autoReload"))return T.playbackFailedTimes=0,T.fetchFailedTimes=0,P(a.get("config.playerHealthDelay"));if(T.fetchFailedTimes>=a.get("config.fetchFailedMax"))return n();if(i>=a.get("config.playerHealthDelayMax"))return document.hidden?n():P(a.get("config.playerHealthDelay"));if(!t.ended&&!t.paused&&![0,4].includes(t.readyState)||t.buffered.length>3||t.paused&&[2,3].includes(t.readyState)&&t.currentTime>10&&t.buffered.length>0)return s();T.playbackFailedTimes=0,P(a.get("config.playerHealthDelay"))}function Qe(){T.fetchFailedTimes++,clearTimeout(ce),ce=setTimeout(()=>{T.fetchFailedTimes=0},a.get("config.resetFetchFailedDelay")),P(a.get("config.waitPlayerError"))}function _t(){const e=document.querySelector(a.get("config.querySelectors.playerOverlay"));if(!e)return fe();e!==ue&&(fe(),ue=e,O=new MutationObserver(t=>{d.playerFit&&t.forEach(n=>{const i=n.addedNodes&&n.addedNodes[0]&&e.querySelector(a.get("config.querySelectors.playerErrorButton"));!i||!a.get("settings.autoReload")||(T.playbackFailedTimes=0,T.fetchFailedTimes=0,i.click(),chrome.runtime.sendMessage({analytics:{name:"player_event",params:{kind:"reload_button"}}}))})}),O.observe(e,{childList:!0}))}function fe(){O&&O.disconnect(),O=null,ue=null}function vt(){let e=document.readyState==="loading";e?document.addEventListener("DOMContentLoaded",t):t();function t(){setTimeout(()=>{ye(e),P(a.get("config.defaultDelay"))},a.get("config.defaultDelay"))}}function ye(e){clearTimeout(re),_e()?k(!1,!0).then(s=>{fetch("https://gql.twitch.tv/gql",{method:"post",headers:s,body:JSON.stringify([{operationName:"UseLive",extensions:{persistedQuery:{sha256Hash:"639d5f11bfb8bf3053b424d9ef650d04c4ebb7d94711d644afb08fe9a0fad5d9",version:1}},variables:{channelLogin:we()}}])}).then(i=>i.json()).then(i=>{try{if(L(i,"getLivestream")){n(!1),C();return}const o=i[0].data.user.stream;d.videoElement=document.querySelector(a.get("config.querySelectors.playerElement")),o&&d.videoElement&&_e()?(n(!0),bt(),t()):(n(!1),C())}catch{n(!1),C()}}).catch(i=>{if(i.message==="Failed to fetch")return Qe();throw n(!1),C(),i})}).catch(s=>{f(s,"getLivestream")}):(n(!1),C()),re=setTimeout(ye,a.get("config.checkLiveDelay"));function t(){Bt(),e&&(Lt(),e=!1)}function n(s){d.playerFit!==s&&(d.playerFit=s,d.playerFit,void 0)}}function _e(e){const t=e||location;return t.host==="player.twitch.tv"?new URL(t.href).searchParams.has("channel"):t.pathname.match(/\/clip\//)?!1:!["","videos","directory","subscriptions","drops","wallet","settings","embed","popout"].includes(t.pathname.split("/")[1])}function ve(e){const t=new URL((e||location).href);return!!t.searchParams&&t.searchParams.get(a.get("config.queryRaid"))==="raid"}function be(){location.href!==d.pageUrl&&(d.prevUrl=d.pageUrl,d.pageUrl=location.href,Et(new URL(d.pageUrl),new URL(d.prevUrl)))}function G(e){d.playerActive!==e&&(d.playerActive=e,wt(d.playerActive))}function $(){if(!d.videoElement){G(!1);return}setTimeout(()=>{G(!!(d.videoElement&&d.videoElement.currentTime>0&&!d.videoElement.paused&&!d.videoElement.ended))},a.get("config.shortDelay"))}function bt(){if(!d.videoElement){G(!1);return}C(),d.videoElement.addEventListener("play",$),d.videoElement.addEventListener("pause",$),d.videoElement.addEventListener("ended",$),d.videoElement.addEventListener("error",$),d.videoElement.addEventListener("abort",$),d.videoElement.addEventListener("canplaythrough",$),$()}function C(){G(!1),d.videoElement&&(d.videoElement.removeEventListener("play",$),d.videoElement.removeEventListener("pause",$),d.videoElement.removeEventListener("ended",$),d.videoElement.removeEventListener("error",$),d.videoElement.removeEventListener("abort",$),d.videoElement.addEventListener("canplaythrough",$))}function Et(e,t){ye(),St(e,t),P(a.get("config.defaultDelay")),Tt(),Y()}function jt(e){}function wt(e){a.get("settings.changeIcon")&&K(e&&!ve())}function Tt(){const e=document.querySelector("._ATBE_alerts");e&&setTimeout(()=>{const t=document.querySelector(a.get("config.querySelectors.playerContainer"))||document.querySelector(a.get("config.querySelectors.mainContainer"));if(t&&e.parentElement!==t){t.append(e);const n=e.querySelectorAll("._ATBE_alerts-item__timer")||[],s=w();for(const i of n){const o=Math.round((s-i.dataset.time)/1e3),c=(i.style.getPropertyValue("--ATBE-duration")||"0s").slice(0,-1)-o;i.style=`--ATBE-duration:${c}s`,i.dataset.time=s}}Ve(e)},a.get("config.waitRenderDelay"))}function St(e,t){if(!a.get("settings.enabled")||!ve(e))return;const n=a.get("settings.cancelRaid"),s=a.get("lastRaids"),i=history.state&&history.state.state&&history.state.state.raid_id||ee(),o=s.some(r=>{if(r.id===i)return!0});n&&setTimeout(()=>{e.searchParams.delete(a.get("config.queryRaid")),history.replaceState(history.state,null,e.href),setTimeout(()=>{history.back(),Xe(e.href)},a.get("config.waitRenderDelay"))},a.get("config.activateWindowDelay")),!o&&Promise.all([z(t.href),z(e.href)]).then(r=>{const c={type:"raids",id:i,status:n?1:0,timestamp:w(),data:{canceled:n,login:r[0].login,displayName:r[0].displayName,to:{login:r[1].login,displayName:r[1].displayName}}};s.unshift(c),I("lastRaids",s),chrome.runtime.sendMessage({analytics:{name:"twitch_event",params:{kind:"raids",value:1}}})}).catch(r=>{f(r,"checkRaid")})}function At(e){if(!a.get("settings.enabled")||!e||!e.id)return;const t=`${e.id}-0`,n=s=>{try{const i=a.get("lastPredictions"),o=i.some(c=>{if(c.id===t)return!0}),r={type:"predictions",id:t,status:0,timestamp:w(),data:Object.assign(JSON.parse(JSON.stringify(e)),{login:s.login,displayName:s.displayName,outcomes:e.outcomes.map(c=>({id:c.id,title:c.title,color:c.color}))})};if(delete r.data.created_by,delete r.data.ended_at,delete r.data.ended_by,delete r.data.locked_at,delete r.data.locked_by,delete r.data.winning_outcome_id,o)return;i.unshift(r),I("lastPredictions",i),chrome.runtime.sendMessage({analytics:{name:"twitch_event",params:{kind:"predictions",action:"start",value:1}}})}catch(i){f(i,"checkPredictionActive")}};W.includes(t)||(W.push(t),Ee(e.channel_id).then(s=>{z(null,s).then(n)}).catch(s=>{f(s,"checkPredictionActive")}))}function $t(e){if(!a.get("settings.enabled")||!e||!e.event_id||!e.channel_id||!e.result)return;const t=e.result.points_won||0,n=e.result.type,s=n==="WIN"?1:n==="LOSE"?2:3,i=`${e.event_id}-${s}`,o=r=>{try{const c=a.get("lastPredictions"),l=c.some(m=>{if(m.id===i)return!0}),u={type:"predictions",id:i,status:s,timestamp:w(),data:{login:r.login,displayName:r.displayName,id:e.event_id,outcome_id:e.outcome_id,channel_id:e.channel_id,updated_at:e.updated_at,status:n,points:e.points,pointsWon:t}};if(l)return;c.unshift(u),I("lastPredictions",c),chrome.runtime.sendMessage({analytics:{name:"twitch_event",params:{kind:"predictions",action:"result",value:t}}})}catch(c){f(c,"checkPredictionResult")}};W.includes(i)||(W.push(i),Ee(e.channel_id).then(r=>{z(null,r).then(o)}).catch(r=>{f(r,"checkPredictionResult")}))}function z(e,t){const n={login:null,id:null,displayName:null,primaryColorHex:null,profileImageURL:null};return new Promise(s=>{if(n.login=t||we(e),!n.login){s(n);return}k().then(i=>{fetch("https://gql.twitch.tv/gql",{method:"post",headers:i,body:JSON.stringify([{operationName:"ChannelShell",extensions:{persistedQuery:{sha256Hash:"580ab410bcd0c1ad194224957ae2241e5d252b2c5173d8e0cce9d32d5bb14efe",version:1}},variables:{login:n.login}}])}).then(o=>o.json()).then(o=>{if(L(o,"getChannelData")){s(n);return}n.id=o[0].data.userOrError.id,n.displayName=o[0].data.userOrError.displayName,n.primaryColorHex=o[0].data.userOrError.primaryColorHex,n.profileImageURL=o[0].data.userOrError.profileImageURL,s(n)}).catch(()=>{s(n)})}).catch(()=>{s(n)})}).catch(s=>{f(s,"getChannelData")})}function Ee(e){return new Promise((t,n)=>{k().then(s=>{fetch("https://gql.twitch.tv/gql",{method:"post",headers:s,body:JSON.stringify([{operationName:"ChannelPanels",extensions:{persistedQuery:{sha256Hash:"06d5b518ba3b016ebe62000151c9a81f162f2a1430eb1cf9ad0678ba56d0a768",version:1}},variables:{id:e}}])}).then(i=>i.json()).then(i=>{if(L(i,"getChannelLogin")){n();return}const o=i[0].data.user.login;if(!o){n();return}t(o)}).catch(()=>{n()})}).catch(s=>{f(s,"getChannelLogin")})})}function K(e){const t=document.querySelector(a.get("config.querySelectors.favicon16")),n=document.querySelector(a.get("config.querySelectors.favicon32"));if(!t||!n)return f("Favicon not found","changeIcon");const s=t.dataset.default,i=n.dataset.default,o=e?E("/img/twitch-icon-red-16.png"):s,r=e?E("/img/twitch-icon-red-32.png"):i;(!s||!i)&&(t.dataset.default=t.href,n.dataset.default=n.href),o&&r&&(t.href=o,n.href=r)}function Ge(e){const t=document.createElement("script");t.innerHTML=`(function () {${e.toString().replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm," ").replace(/[\r\n]+/g," ").replace(/\s\s+/g," ").trim().match(/^.*?{(.+)}.*$/)[1]}})('${qe}');`,De.prepend(t)}function kt(){const e=document.cookie.match(/(?:^|; )auth-token=([^;]*)/);return e?`OAuth ${e[1]}`:void 0}function Lt(){if(D||!d.playerFit||d.playerActive||!a.get("settings.autoStart"))return;const e=()=>{try{Object.defineProperty(window.document,"hidden",{get:()=>!1,configurable:!0}),Object.defineProperty(window.document,"visibilityState",{get:()=>"visible",configurable:!0}),window.document.dispatchEvent(new Event("visibilitychange")),setTimeout(()=>{delete window.document.hidden,delete window.document.visibilityState},1e3)}catch{}},t=n=>{n&&d.videoElement.play().catch(()=>t(--n))};Ge(e),chrome.runtime.sendMessage("activateTab"),t(300)}function Bt(){if(D||!d.playerFit||!d.videoElement||!d.videoElement.muted||d.videoElement._ATBE_activated||!a.get("settings.preventPause"))return;let e=a.get("config.unmuteRetries");const t=.011,n=()=>{d.videoElement.volume!==t&&(r=d.videoElement.volume,d.videoElement.volume=t)},s=()=>{i()&&(document.removeEventListener("visibilitychange",s),o(!0))},i=()=>document.visibilityState==="visible",o=c=>{if(!(!d.videoElement||!d.videoElement.muted)){if(!c&&(d.videoElement.paused||!d.videoElement.currentTime)){e&&(setTimeout(o,a.get("config.unmutePlayerDelay")),e--);return}d.videoElement.volume=t,d.videoElement.muted=!1,d.videoElement.addEventListener("volumechange",n),setTimeout(()=>{d.videoElement&&(d.videoElement.removeEventListener("volumechange",n),d.videoElement.muted=!0,d.videoElement.volume=r,d.videoElement._ATBE_activated=!0)},a.get("config.unmutePlayerDelay")*(i()?1:2))}};let r=d.videoElement.volume;i()?o():document.addEventListener("visibilitychange",s)}function we(e){const t=new URL(e||location.href);return t.host==="player.twitch.tv"?t.searchParams.get("channel")||"":t.pathname.split("/")[1]}function E(e){try{return chrome.runtime.getURL(e)}catch{}}function ze(e){setTimeout(X,typeof e=="number"?e:a.get("config.reloadDelay"))}function Ke(){const e=location.pathname.split("/"),t=location.hash===a.get("config.hashPointsFs"),n=location.hash===a.get("config.hashPointsFsP"),s=a.get("config.hashDrop"),i=()=>{const r=document.querySelector(a.get("config.querySelectors.pointsButton")),c=new MutationObserver(l=>{l.some(u=>{if(u.removedNodes&&u.removedNodes.length)return document.body.classList.remove("_ATBE_points-fs"),document.body.classList.remove("_ATBE_points-fs_predict"),r.disabled=!1,c.disconnect(),!0})});if(!r){setTimeout(i,a.get("config.activateWindowDelay"));return}if(r.click(),r.disabled=!0,n)setTimeout(()=>{const l=document.querySelector(a.get("config.querySelectors.predictionsButton"));l&&l.click()},a.get("config.shortDelay"));else{const l=document.querySelector(a.get("config.querySelectors.pointsSummary"));l&&l.parentElement&&c.observe(l.parentElement,{subtree:!1,childList:!0})}},o=()=>{const r=decodeURIComponent(location.hash.slice(s.length)).replace(/&/g,"&amp;"),c=document.querySelectorAll(a.get("config.querySelectors.dropsName"));if(!c.length){setTimeout(o,a.get("config.activateWindowDelay"));return}[].some.call(c,l=>{if(l.innerHTML===r){let u=l;for(;u;){const m=u.parentElement;if(m&&m.matches(a.get("config.querySelectors.dropsWrapper")))break;u=m}return u&&(u.classList.add("_ATBE_drop-highlight"),u.scrollIntoView({behavior:"smooth",block:"center"})),!0}})};if(location.host==="www.twitch.tv"){if(!document.body)return setTimeout(Ke,a.get("config.shortDelay"));if((t||n)&&e[1]&&["popout","embed"].includes(e[1])&&e[3]&&e[3]==="chat"){document.body.classList.add("_ATBE_points-fs"),n&&document.body.classList.add("_ATBE_points-fs_predict"),i(),chrome.runtime.sendMessage({analytics:{name:"page_view",params:{page_title:"Points_View",page_location:"/twitch/points-view"}}});return}location.hash.slice(0,s.length)===s&&e[1]&&e[1]==="drops"&&e[2]&&e[2]==="inventory"&&(o(),chrome.runtime.sendMessage({analytics:{name:"page_view",params:{page_title:"Drops_View",page_location:"/twitch/drops-view"}}}))}}function Pt(){const e=t=>{const n=document.querySelector(`.${t}`);n&&n.classList.remove(t)};e("_ATBE_points-fs_predict"),e("_ATBE_points-fs"),e("_ATBE_drop-highlight")}function Z(){const e="_ATBE_hide-extensions";if(!document.body)return setTimeout(Z,a.get("config.shortDelay"));if(!D&&a.get("settings.enabled")&&a.get("settings.hideExtensions")){document.body.classList.add(e);return}document.body.classList.remove(e)}function Te(){let e=null,t=null,n=200;const s="_ATBE_nav-popup-preview",i="_ATBE_nav-popup-preview_hidden",o=h=>{const _=e;fetch(`https://static-cdn.jtvnw.net/previews-ttv/live_user_${e}-320x180.jpg`).then(v=>v.blob()).then(v=>{_===e&&(h.src=URL.createObjectURL(v),h.classList.remove(i))})},r=h=>{const _=t&&t.querySelector(a.get("config.querySelectors.navPopupBody"));if(!_||!e){h&&setTimeout(()=>r(h-1),10);return}let v=_.querySelector(`.${s}`);if(v){o(v);return}v=document.createElement("img"),v.classList.add(s),o(v),_.append(v)},c=h=>{e=h.target.href.split("/").pop(),setTimeout(()=>r(3),0)},l=()=>{const h=t&&t.querySelector(a.get("config.querySelectors.navPopupBody"));if(!h)return;const _=h.querySelector(`.${s}`);_&&_.classList.add(i)},u=()=>{const h=document.querySelectorAll(a.get("config.querySelectors.navLinks"));for(const _ of h)H(_,"mouseenter",c,se),H(_,"mouseleave",l,se)},m=()=>{const h=document.querySelector(a.get("config.querySelectors.navWrapper"));if(!h){n--,n&&setTimeout(m,a.get("config.shortDelay"));return}u(),x=new MutationObserver(u),x.observe(h,{childList:!0,subtree:!0}),F=new MutationObserver(_=>{_.forEach(v=>{if(v.addedNodes&&v.addedNodes.length){for(const ne of v.addedNodes)if(ne.classList.contains(a.get("config.querySelectors.navPopup").slice(1))){t=ne,r(6);break}}})}),F.observe(document.body,{childList:!0,subtree:!1})};(()=>{qt(se),x&&x.disconnect(),x=null,F&&F.disconnect(),F=null})(),!D&&a.get("settings.enabled")&&a.get("settings.showPreviews")&&m()}function Ze(){try{chrome.runtime.sendMessage("PING")}catch(e){e.message==="Extension context invalidated."&&(me(),ze())}Ce=setTimeout(Ze,a.get("config.playerHealthDelay"))}function Dt(){let e=document.cookie.match(/(?:^|; )twilight-user=([^;]*)/);if(e=e&&JSON.parse(decodeURIComponent(e[1])),localStorage.setItem("mature","true"),localStorage.setItem("channelPointsOnboardingDismissed","true"),localStorage.setItem("powerUpsFtueDismissed","true"),localStorage.setItem(`bits_power_ups_callout_dismissed.${e?e.id:""}`,"true"),localStorage.setItem(`cosmic_abyss_callout_dismissed.${e?e.id:""}`,"true"),location.hostname==="www.twitch.tv"&&location.pathname.slice(0,7)==="/embed/"){const t=new URL(location.href);localStorage.getItem("twilight.theme")!=="0"&&!t.searchParams.has("darkpopout")&&(t.searchParams.append("darkpopout",""),location.href=t)}}function k(e,t){let n=200,s=!1;const i=kt(),o=localStorage.getItem("local_storage_app_session_id"),r=localStorage.getItem("local_copy_unique_id"),c={"Client-Id":a.get("clientId"),"Client-Version":a.get("clientVersion"),"Client-Session-Id":o&&JSON.parse(o)||ee(16),"X-Device-Id":r&&JSON.parse(r)},l=()=>{window.postMessage({autoTwitchBrowserExtensionIntegrity:c},"*")};return i&&(c.Authorization=i),e&&(R=null),new Promise((u,m)=>{try{const S=w(),h=()=>{if(!n--)return m("Max tries exceeded while getting integrity token");if(R&&R.token&&R.expiration>w())return c["Client-Integrity"]=R.token,u(c);s||(Re+1e3<S&&(Re=S,l()),s=!0),setTimeout(h,100)};if(!i&&!t||!r)return m("No authorization");h()}catch(S){f(S,"getHeaders")}})}function X(e){if(a.get("settings.enabled")){if(e){e==="integrityFail"&&chrome.runtime.sendMessage({removeCookies:[{name:"KP_UIDZ",url:"https://gql.twitch.tv"},{name:"KP_UIDZ-ssn",url:"https://gql.twitch.tv"}]});const t=new URL(location.href);t.searchParams.set(a.get("config.queryReload"),e),location.href=t.href;return}try{f(new Error("RELOAD: system"),"processReload")}catch{}location.reload()}}function Xe(e){const t=new URL(location.href),n=t.searchParams.get(a.get("config.queryReload")),s=typeof n=="string"||e,i=l=>{clearTimeout(de),de=setTimeout(()=>{if(!r&&document.querySelector(a.get("config.querySelectors.mainContainer"))){r=!0;const m=a.get("lastReloads");m.unshift({type:"reloads",timestamp:w(),id:ee(24),status:1,data:{reloadType:n,page:t.href}}),I("lastReloads",m)}const u=document.querySelector(a.get("config.querySelectors.offlineChannelHeader"));c||(u?(c=!0,e&&history.replaceState(history.state,null,e),u.click()):document.querySelector(a.get("config.querySelectors.aboutSection"))&&(c=!0)),o++,o<20&&(!r||!c)&&i()},l||a.get("config.transitionDelay"))};let o=0,r=!!e,c=!1;s&&(t.searchParams.delete(a.get("config.queryReload")),history.replaceState(history.state,null,t.href),document.readyState==="complete"?i():document.addEventListener("DOMContentLoaded",()=>i(a.get("config.reloadDelay"))))}function Se(e,t){const n="https://www.twitch.tv/embed/",s=a.get("config.hashPointsFs"),i=a.get("config.hashPointsFsP");let o="parent=www.twitch.tv&parent=player.twitch.tv";if(t){const r=new URL(location.href).searchParams.getAll("parent");r&&r.forEach(c=>{o+=`&parent=${c}`})}return`${n}${e}/chat?${o}${t?i:s}`}function Y(){let e=150,t=null,n=document.querySelector(a.get("config.querySelectors.playerClicker"));const s=()=>{if(!n){--e&&(n=document.querySelector(a.get("config.querySelectors.playerClicker")),setTimeout(s,a.get("config.shortDelay")));return}let o=document.querySelector("._ATBE_pause-icon");if(!o){const r=document.querySelector(a.get("config.querySelectors.playerContainer"));if(!r)return;o=document.createElement("div"),o.classList.add("_ATBE_pause-icon"),o.style.setProperty("--ATBE-icon-pause",`url(${E("/img/pause-icon.svg")})`),r.append(o)}H(n,"mousedown",r=>{r.button===0&&(t=Date.now(),o.classList.add("_ATBE_pause-icon_active"))}),H(n,"mouseup",r=>{if(r.button===0&&t&&Date.now()>t+400){const c=document.querySelector(a.get("config.querySelectors.playerElement"));c&&!c.ended&&!c.paused&&c.pause()}t=null,o.classList.remove("_ATBE_pause-icon_active")}),H(n,"mouseleave",()=>{t=null,o.classList.remove("_ATBE_pause-icon_active")})};(()=>{n&&(te(n,"mousedown"),te(n,"mouseup"),te(n,"mouseleave"),n=null,t=null)})(),!D&&a.get("settings.enabled")&&a.get("settings.clickPause")&&s()}function It(e){chrome.runtime.sendMessage({openHelp:!0,section:e})}function Nt(){if(d.integrityFailed++,clearTimeout(le),a.get("settings.integrityReload")&&d.integrityFailed>=a.get("config.integrityFailedMax")&&Ye("config.reloadAutoDelay"))return f(new Error(`RELOAD: {"integrityFailed":${d.integrityFailed}}`),"processIntegrityFailed"),X("integrityFail");le=setTimeout(()=>{d.integrityFailed=0},a.get("config.resetIntegrityFailedDelay")),k(!0)}function f(e,t){console.group(`%c ATBE PROCESS INFO (${new Date().toLocaleTimeString()}) [${t||"-"}] `,"color: white; background: blue;"),console.info(e),console.groupEnd();const n=e.toString();["No authorization","error: Max tries exceeded"].includes(n)||chrome.runtime.sendMessage({analytics:{name:"extension_error",params:{message:`${e.message||n} [${t||"-"}]`}}}),n==="Error: CRITICAL: failed integrity check"&&Nt()}function L(e,t){return e&&e[0]&&e[0].errors&&e[0].errors[0]?(f(new Error(`CRITICAL: ${e[0].errors[0].message}`),t),!0):!1}function w(){return new Date().getTime()}function Ye(e){return lt+a.get(e)<w()}function ee(e){const t="abcdefghijklmnopqrstuvwxyz0123456789",n=t.length,s=e||10;let i="";for(var o=0;o<s;o++)i+=t.charAt(Math.floor(Math.random()*n));return i}function H(e,t,n,s){e.addEventListener(t,n),e._ate_listeners=e._ate_listeners||{},e._ate_listeners[t]=e._ate_listeners[t]||[],e._ate_listeners[t].push(n),s&&s.push(e)}function te(e,t){const n=s=>{e._ate_listeners[s]&&e._ate_listeners[s].forEach(i=>{e.removeEventListener(s,i)})};if(e._ate_listeners){if(t){n(t),delete e._ate_listeners[t];return}Object.keys(e._ate_listeners).forEach(n),e._ate_listeners={}}}function qt(e){e.forEach(t=>{te(t)}),e.length=0}function et(e,t,n){!e||!e.length||e.forEach(s=>s.addEventListener(t,n))}function Ct(e){const t=new URL(e);return e?`${t.hostname}${t.pathname}`:"?"}function Rt(e){return`${e[0].toUpperCase()}${e.slice(1)}`}function p(e){var t="";return Array.isArray(e)?t=chrome.i18n.getMessage(e[0],e.splice(1)):t=chrome.i18n.getMessage(e),t.length?t:"{no translation}"}function J(e){return JSON.parse(JSON.stringify(e))}})();
