/*!
 * ExtStorageManager
 * Part of the ExtHelpers project
 * @version  v1.7.2
 * @author   Gerrproger
 * @license  MIT License
 * Repo:     http://github.com/gerrproger/ext-helpers
 * Issues:   http://github.com/gerrproger/ext-helpers/issues
 */(function(d,c){"use strict";typeof module=="object"&&typeof module.exports=="object"?module.exports=c(d,document):typeof define=="function"&&define.amd?define(null,function(){c(d,document)}):d.ExtStorageManager=c(d,document)})(typeof window<"u"?window:this,function(d,c){"use strict";return function(u,g,l){class p{constructor(t="sync",e={},s=()=>{}){const i=function(){if(!this.initialized)throw new o("Storage is not initialized yet!");return arguments[0].apply(this,Array.prototype.slice.call(arguments,1))};this.name=t,this.callback=s,this.onUpdateCalls=[],this.data={},this.defData=e||{},this.skip=!1,this.initialized=!1,this.nativeStorage=chrome.storage[t],this.api={get:i.bind(this,this.get),set:i.bind(this,this.set),remove:i.bind(this,this.remove),reset:i.bind(this,this.reset),clear:i.bind(this,this.clear),onUpdate:this.onUpdate.bind(this),offUpdate:this.offUpdate.bind(this),getBytesInUse:this.getBytesInUse.bind(this),limits:this.limits},this.nativeStorage.get(this._checkStorage.bind(this)),this.nativeStorage.onChanged.addListener(this._updateStorage.bind(this))}_checkStorage(t){const e=this._extend(t,this.defData),s=chrome.runtime.lastError&&chrome.runtime.lastError.message;if(this.data=e.object,e.changed.length){const i={};e.changed.forEach(n=>{i[n]=this.data[n]}),this.nativeStorage.set(i)}if(this.initialized=!0,this.callback.call(d,this.get(),s),s)throw new o(s)}_isObject(t){return t!==null&&typeof t==="object"&&!Array.isArray(t)}_copyObject(t){return JSON.parse(JSON.stringify(t))}_extend(t,e){const s=[],i=a=>{!s.includes(a)&&s.push(a)},n=(a,f,r)=>{Object.keys(f).forEach(h=>{a[h]===void 0?(a[h]=f[h],i(r||h)):this._isObject(f[h])&&n(a[h],f[h],r||h)})};return t=this._copyObject(t||{}),e=this._copyObject(e||{}),n(t,e),{object:t,changed:s}}_updateStorage(t){if(this.skip)return;const e=[],s=(i,n,a)=>{const f=Object.keys(i);if(!f.length){e.push(a);return}f.forEach(r=>{this._isObject(i[r])&&this._isObject(n[r])?s(i[r],n[r],`${a}.${r}`):i[r]!==n[r]&&e.push(`${a}.${r}`)})};Object.keys(t).forEach(i=>{if(!t[i].hasOwnProperty("newValue")){delete this.data[i],e.push(i);return}this._isObject(t[i].newValue)&&this._isObject(this.data[i])?s(t[i].newValue,this.data[i],i):t[i].newValue!==this.data[i]&&e.push(i),this.data[i]=t[i].newValue}),e.forEach(i=>{this.onUpdateCalls.forEach(n=>{(new RegExp(`^${n[0].replace(/\./g,"\\.")}`).test(i)||new RegExp(`^${i.replace(/\./g,"\\.")}`).test(n[0]))&&n[1].call(d,this.get(n[0]))})})}_replaceStorage(t,e){t=this._copyObject(t);const s=Object.keys(this.data).filter(i=>!t.hasOwnProperty(i));this.data=t,this.skip=!0,s.length&&this.nativeStorage.remove(s,this._callback.bind(this,e)),this.nativeStorage.set(this.data,()=>{this.skip=!1,this._callback(e,chrome.runtime.lastError)})}_callback(t,e){e=e||chrome.runtime.lastError;const s=e&&e.message;if(typeof t=="function"&&t.call(d,s),s)throw new o(s)}get(t){if(!t)return this._copyObject(this.data);let e=this.data;return t.split(/\./g).some(i=>{if(e&&e[i]!==void 0)e=e[i];else return!0})?void 0:this._isObject(e)?this._copyObject(e):e}set(t,e,s){if(t&&typeof t!="string")throw new o("Path should be a string!");if(s&&typeof s!="function")throw new o("Callback should be a function!");if(this._isObject(e)&&(e=this._copyObject(e)),!t){if(!this._isObject(e))throw new o("Could not store a non-object in the storage root!");return this._replaceStorage(e,s),this.api}let i=this.data;const n=t.split(/\./g),a=n.length-1;if(n.some((r,h)=>{if(h===a)i[r]=e;else if(i[r]===void 0)i=i[r]={};else if(this._isObject(i[r]))i=i[r];else return!0}))throw new o("One of the path nestings is not an object!");return this.nativeStorage.set({[n[0]]:this.data[n[0]]},this._callback.bind(this,s)),this.api}remove(t,e,s){if(typeof e=="function"&&s===void 0&&(s=e,e=!1),!t)throw new o("Path is not passed!");if(e!==void 0&&typeof e!="boolean")throw new o("SkipNonexistent should be a boolean!");if(s!==void 0&&typeof s!="function")throw new o("Callback should be a function!");const i=t.split(/\./g),n=i.length-1;if(!n){if(!this.data.hasOwnProperty(i[0])){if(e)return this._callback(s),this.api;throw new o("Passed path does not exists!")}return delete this.data[i[0]],this.nativeStorage.remove(i[0],this._callback.bind(this,s)),this.api}let a=this.data;if(i.some((r,h)=>{if(h===n){if(a[r]===void 0)return!0;delete a[r],this.nativeStorage.set({[i[0]]:this.data[i[0]]},this._callback.bind(this,s))}else if(this._isObject(a[r]))a=a[r];else throw new o("One of the path nestings is not an object!")})){if(!e)throw new o("Passed path does not exists!");this._callback(s)}return this.api}onUpdate(t,e,s){if(typeof t=="function"&&(e=t,s=e,t=null),typeof e!="function")throw new o("Callback function is not passed!");if(s&&typeof s!="string")throw new o("Namespace should be a string or undefined!");return this.onUpdateCalls.push([t||"",e,s||""]),this.api}offUpdate(t){if(t&&typeof t!="string")throw new o("Namespace should be a string or undefined!");return this.onUpdateCalls=t?this.onUpdateCalls.filter(e=>e[2]!==t):[],this.api}reset(t){if(t&&typeof t!="function")throw new o("Callback should be a function!");return this._replaceStorage(this.defData,t),this.api}clear(t){if(t&&typeof t!="function")throw new o("Callback should be a function!");return this._replaceStorage({},t),this.api}getBytesInUse(t,e){if(typeof t=="function")e=t,t=null;else if(typeof e!="function")throw new o("Callback function is not passed!");return this.nativeStorage.getBytesInUse(t||null,s=>{const i=this.nativeStorage[`QUOTA_BYTES${t?"_PER_ITEM":""}`];e.call(d,s,i)}),this.api}get limits(){return{maxItems:this.nativeStorage.MAX_ITEMS,maxSustainedWriteOperationsPerMinute:this.nativeStorage.MAX_SUSTAINED_WRITE_OPERATIONS_PER_MINUTE,maxWriteOperationsPerHour:this.nativeStorage.MAX_WRITE_OPERATIONS_PER_HOUR,maxWriteOperationsPerMinute:this.nativeStorage.MAX_WRITE_OPERATIONS_PER_MINUTE,quotaBytes:this.nativeStorage.QUOTA_BYTES,quotaBytesPerItem:this.nativeStorage.QUOTA_BYTES_PER_ITEM}}}class o extends Error{constructor(t){super(t),this.name="ExtStorageManagerError",this.stack=this.stack.replace(/\s\s\s\sat Storage.+(\n|$)/g,"")}}return new p(l,u,g).api}});
