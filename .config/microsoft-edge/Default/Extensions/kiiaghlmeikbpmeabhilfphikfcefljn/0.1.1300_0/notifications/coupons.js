import{a as M,e as ue,f as de}from"../chunks/chunk-CXWJ3UUV.js";import"../chunks/chunk-RDQO4EI3.js";import{a as F,f as re,g as ce,i as pe,x as ge,z as me}from"../chunks/chunk-HDCG35CA.js";import"../chunks/chunk-GQ2ZFDTT.js";import"../chunks/chunk-QQFNG2AW.js";import"../chunks/chunk-QTFDT3SV.js";import"../chunks/chunk-ZMUT3H36.js";import{a as Se,b as we}from"../chunks/chunk-KWXANPNS.js";import{a as y,b as P}from"../chunks/chunk-OOVGOOFN.js";import{C as ie,E as ne,G as E,c as Y,d as Z,e as ee,i as te}from"../chunks/chunk-JMZ6COH5.js";import{c as ae}from"../chunks/chunk-TL3QIPOO.js";import"../chunks/chunk-5JMRRCOD.js";import{a as se}from"../chunks/chunk-IDR6MOLX.js";import"../chunks/chunk-J5F3A7TB.js";import"../chunks/chunk-LZ4BOSIO.js";import"../chunks/chunk-UWSVS74H.js";import"../chunks/chunk-UK623MXR.js";import{a as le}from"../chunks/chunk-DB2INE3Z.js";import"../chunks/chunk-5DIWEA5K.js";import"../chunks/chunk-C3OCDYXE.js";import{a as oe}from"../chunks/chunk-2R34RLZD.js";import{a as U}from"../chunks/chunk-VMXEY2MG.js";import{a as he}from"../chunks/chunk-DYSWDVEG.js";import{a as fe}from"../chunks/chunk-VQDKWH7E.js";import{b as Pe}from"../chunks/chunk-EABUY6YE.js";import{a as B,b as Oe}from"../chunks/chunk-JWRT5PWI.js";import"../chunks/chunk-XNQV75SS.js";import"../chunks/chunk-JDV5FZKX.js";import{a as X}from"../chunks/chunk-RDRL4ZUL.js";import"../chunks/chunk-BCG2KUGW.js";import{a as j}from"../chunks/chunk-35WHJZQO.js";import"../chunks/chunk-NUCLT2FJ.js";import{b as Q}from"../chunks/chunk-2IU7RY3W.js";import"../chunks/chunk-542QW3ZK.js";import"../chunks/chunk-IYAFYZRF.js";import"../chunks/chunk-JNO5G2QC.js";import"../chunks/chunk-ZRXJBILZ.js";import"../chunks/chunk-F2BE3OL5.js";import"../chunks/chunk-AZABECDO.js";import"../chunks/chunk-AJE3NLZ4.js";import"../chunks/chunk-TOX56BBT.js";import"../chunks/chunk-TYA5STFG.js";import"../chunks/chunk-KWORSN6K.js";import{e as K,p as x}from"../chunks/chunk-TXXCCNWI.js";import"../chunks/chunk-O4TFJKJQ.js";import{a as b,b as H,g as f,m as t,s as I,t as S,w as $}from"../chunks/chunk-CHZKSFGE.js";import"../chunks/chunk-JLZNCAMO.js";import"../chunks/chunk-PVPCVBPO.js";import"../chunks/chunk-Z4H6U7OH.js";import{g as z,m as q,t as Ve}from"../chunks/chunk-LIVBINA3.js";import{b as G,c as Le}from"../chunks/chunk-HQ4MM2EX.js";import"../chunks/chunk-4TYY7CF3.js";import"../chunks/chunk-VCHBXYSK.js";import"../chunks/chunk-ZIVQ3XHH.js";import"../chunks/chunk-JDJMGFXU.js";import"../chunks/chunk-T5WNPH4X.js";import"../chunks/chunk-ECXCPAF6.js";import"../chunks/chunk-CBPLEXH3.js";import{b as T,c as Ne}from"../chunks/chunk-IUWVXOWN.js";import{b as Re,c as Ae}from"../chunks/chunk-HPNQXUCM.js";import"../chunks/chunk-53OM6ECF.js";import"../chunks/chunk-KUOYBGP4.js";import"../chunks/chunk-PDIOZR2P.js";import"../chunks/chunk-KSIO6WHA.js";import"../chunks/chunk-BETA3R27.js";import{e as k}from"../chunks/chunk-3GYLW4KZ.js";var De=k(Re());Ve();var o=k(Ae());var _e=k(Pe());Ne();Oe();Le();var Ce=()=>$("hasDeferredCouponRewards");var W=k(K());window.__wb_timing.couponsRequireAt=performance.now();var xe=new Set(["etsy.com","amazon.com"]),V=!1,R=!1,Fe=o.default.throttle(X,2e3),Ue=()=>{setTimeout(()=>{let e={currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])},s=o.default.extend({},window.__wb_timing,e);S("track","pageTimingMetrics",s)},5e3)};function Ee(){return De.default.all([fe(),U(),te(),le(),Ce(),we(),Se()]).spread((e,s,c,n,a,p,u)=>{he(e),t.merge({siteAPIData:s}),t.merge({cashback:c}),t.set("lifetimeSavings",n),t.set(["couponView","hasDeferredCouponRewards"],a),t.set(["couponView","elasticityUserDomain"],p),t.set("domainLists",u)})}var Me=[{domain:"etsy.com"},{domain:"amazon.com",condition:e=>{let s=o.default.get(e,"pageType")==="checkoutPage",c=o.default.get(e,"pageData.meta"),n=c?c.coupon_input_present:!1;return s&&n}}];function Te(e,s){return!!o.default.find(Me,n=>n.domain===e&&(n.condition?n.condition(s):!0))}async function We(){T("COUPONS INIT");let[e,s,c,n]=await Promise.all([y("emailCreateAccount"),y("affiliateRedirect"),y("couponRun"),y("tripId"),Ee()]);T("COUPONS DATA LOADED");let a=b();if(Ue(),navigator.userAgent.indexOf("Firefox")>-1&&a.match(/eyebuydirect\.com/))return!1;let p=t.get("cashback");if(e&&JSON.parse(e)?.shouldLoadNotification&&(await P("emailCreateAccount"),ae(o.default.get(p,"reward",null))),s){let r=JSON.parse(s);t.set("affiliateRedirect",r)}else c||(sessionStorage.removeItem("__s_sitehub_try_codes"),n&&P("tripId"));n&&t.set(["couponView","tripId"],n),t.set("couponsVisible",!1);let u=t.get("siteAPIData");await Ge(u);let m=await He(u),g;try{g=JSON.parse(sessionStorage.getItem("ogPageData")),g&&g.expires<B()&&(sessionStorage.removeItem("ogPageData"),g=null)}catch{}async function w(r){if(T("onDeweyResult",r),Fe(a,r),await Be(r),r.callSource==="internal"&&r.pageData)try{let i=JSON.parse(sessionStorage.getItem("cartTotalAfterSavings"));if(sessionStorage.removeItem("cartTotalAfterSavings"),!Number.isNaN(i.value)){let C=Date.now()-i.time;r.pageData?.order?.total>i.value&&C<2e3&&S("track","extensionError",{type:"coupon_error"})}}catch{}if(r.callSource==="coupons_start"&&r.pageData)sessionStorage.setItem("ogPageData",JSON.stringify({...r.pageData,expires:q(z(new Date,3))}));else if(r.callSource==="coupons_end"){let i=t.select("couponView").get("resultTemp");i||(i=t.select("couponView").get("result"),i.pageReload=void 0);try{g=JSON.parse(sessionStorage.getItem("ogPageData"))}catch{}sessionStorage.removeItem("ogPageData");let C=o.default.get(g,"order.total");if(i.deweyOriginalTotal=C,i.savings>0){o.default.get(r,"pageData.products.length")>1?r.pageData.products=o.default.map(r.pageData.products,(h,L)=>(o.default.has(h,"list_price")&&o.default.has(g,`products[${L}].list_price`)&&g.products[L].list_price-h.list_price&&(h.coupon_savings=g.products[L].list_price-h.list_price),h.coupon_applied=i.bestCoupon.code,h)):o.default.get(r,"pageData.products.length")===1&&(r.pageData.products[0].coupon_savings=i.savings,r.pageData.products[0].coupon_applied=i.bestCoupon.code);let v=r.pageData?.order?.total;v>0&&sessionStorage.setItem("cartTotalAfterSavings",JSON.stringify({value:v,time:Date.now()}))}let N=b(),l=t.get("couponsConfig");if(l&&l.pageWasReloaded){l.result=i;let v=t.get("couponView"),h=o.default.get(v,"resultTemp.allCoupons",[]);xe.has(N)&&h.length>0&&(l.coupons=o.default.cloneDeep(h)),D(l,p)}else t.select("couponView").set("result",i);i&&i.couponScriptType==="roo"&&S("track","rooActionTiming",{triggerType:F({automaticCouponsRun:i.automaticCouponsRun,autoFallback:i.autoFallback,isSiteHub:i.isSiteHub}),couponRunId:i.couponRunId,aggApplyCodeTime:i.aggApplyCodeTime,aggGetTotalTime:i.aggGetTotalTime,aggRemovePreviousTime:i.aggRemovePreviousTime,aggWaitForReloadTime:i.aggWaitForReloadTime,initialActionTime:i.initialActionTime,currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])});let{automaticCouponsRun:ve,autoFallback:ke,isSiteHub:be}=i,Ie=F({automaticCouponsRun:ve,autoFallback:ke,isSiteHub:be});je({couponResult:i,triggerType:Ie,siteAPIData:u}),S("track","deweyResult",o.default.assign(r,{url:window.location.href}))}else if(g&&o.default.get(r,"pageType")&&!R)R=!0,m();else if(Te(a,r)&&!V){if(o.default.get(r,"pageData"))if(a==="amazon.com")await ye(r,m,p);else{let i=await m();if(i){V=!0;let C=await f({message:"getClassifierCodes",domain:a,pageData:r.pageData});if(C){let N=o.default.get(u,"siteData.coupons.count"),l=o.default.concat(C,i.coupons);l=o.default.uniqBy(l,"code"),l=l.slice(0,N),i.coupons=l}D(i,p)}}}else if(R&&I("ext_coupons_skip_cashback_fallback")&&u?.siteData?.coupons?.type==="roo"&&(r.pageType==="cartPage"||r.pageType==="checkoutPage")&&!t.get(["couponView","rooIsCheckingForCouponPage"])&&!t.get(["couponView","rooIsCouponPage"])){let i=await m();i&&D(i,p)}else!I("ext_coupons_skip_cashback_fallback")&&!t.get("cashbackVisible")&&!o.default.get(p,"postCoupons")&&setTimeout(()=>{if(!t.get("couponsVisible")){let i=t.get("deweyResult");E(i)}},1e3)}let A=await y("rooReloading"),d=t.get("deweyResult");d&&!A&&w(d),A&&await P("rooReloading"),se.emitter.on("result",w),await oe(),d=t.get("deweyResult");let O=Te(a,d),_;!O&&!R&&(R=!0,_=await m());let J=o.default.get(d,"pageData");if(O){if(a==="amazon.com")await ye(d,m,p);else if(J&&!V){let r=await m();if(r){V=!0;let i=await f({message:"getClassifierCodes",domain:a,pageData:J});i&&(r.coupons=i),D(r,p)}}}_&&!_.pageWasReloaded&&D(_,p)}async function D(e,s){T("PREPARE COUPONS",{coupons:e,cashback:s});let{standDown:c}=e,n=b();t.merge("couponView",e);let a=t.get("cashbackView")||s;t.set("cashbackView",a);let p={cssUrl:"coupons.css"};if(a&&o.default.get(a,"user.compInactivated")&&ne()&&!t.get("cashbackReactivateVisible")&&!t.get("throttleCreditsReactivation")){t.set(["warnAboutStandDown"],!0),t.set("cashbackReactivateVisible",!0),x({...p,appName:"reactivate",app:(0,W.jsx)(ie,{})});return}(sessionStorage.getItem("__wb_same_tab_auto")||sessionStorage.getItem("__r_reload_auto"))&&await f({domain:n,message:"endThrottle"});let m=pe(),g=n;j(n)&&t.get("deweyResult","pageType")==="checkoutPage"&&(g="amazon.com_checkout");let w=await f({domain:g,message:"isThrottled",isAutoCoup:m});if(m&&await f({domain:g,message:"isAutoCoupThrottled",isAutoCoup:m})){if(t.get("affiliateRedirect")&&!localStorage.getItem("__wb_redirecting")){w||ce();return}t.select("couponView").set("autoCoupThrottled",!0)}let A=!!t.get(["events","hasSeenCouponsThrottleToolTip"]),d=w&&!A&&!e.pageWasReloaded;if(t.select("couponView").set("showThrottleToolTip",d),w&&!e.pageWasReloaded&&(t.set("couponsThrottled",!0),!d)){I("ext_coupons_skip_cashback_fallback")&&!I("ext_coupons_skip_cashback_when_throttled")&&E(t.get("deweyResult"));return}if(c){t.set("couponsThrottled",!0),Z();return}else if(Y()){ee();return}n==="groupon.com"&&S("track","foundCouponsEnd",{pageViewId:t.get("pageViewId")}),t.get("couponsVisible")||(t.set("couponsVisible",!0),x({...p,appName:ue,app:(0,W.jsx)(de,{})}))}function Je(e){S("track","platformIdentified",{platform:e,currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])})}async function ze(){if(t.get("platform")==="Shopify"){let s=window.location.hostname,c=t.get("platformSiteUrl");c&&(s=(0,_e.getSiteDomainFromUrl)(c));let n=await f({message:"makeRequest",reqInfo:{method:"GET",url:`https://${s}/cart.json`,headers:{Accept:"*/*"}}});if(n?.items?.length>0)return qe(n)}}function qe(e){let s=o.default.map(e.items,c=>o.default.pick(c,["id","product_id","sku","url","discounts","discounted_price","original_price","image","title","variant_title"]));return JSON.stringify({cartLevelDiscountApplications:e?.cart_level_discount_applications,cartItems:s,originalTotal:e?.original_total_price,totalDiscount:e?.total_discount,totalPrice:e?.total_price})}async function Be(e){let s=b();if(t.get("platform")==="Shopify"&&e&&e.pageType==="checkoutPage"){let n=document.querySelectorAll(".notice.notice--warning .notice__text"),a=o.default.find(n,p=>p.offsetHeight>0);if(a){let p=a.querySelector("strong").innerText.trim();S("track","shopifyInvalidCouponDetected",{domain:s,coupon:p})}}}async function Ge(e){let s=o.default.get(e,"tld");H(s);let[c,n,a]=await Promise.all([f({message:"getPlatform"}),f({message:"getPlatformDomain"}),f({message:"getPlatformSiteUrl"})]);c&&(t.set("platform",c),Je(c),n&&t.set("platformDomain",n),a&&t.set("platformSiteUrl",a))}async function He(e){let s=t.get("platform"),c=t.get("platformDomain"),n=t.get("platform")==="Shopify";return o.default.get(e,"siteData.coupons.ignoreSite")?o.default.noop:o.default.get(e,"siteData.coupons.type")==="eeyore"&&o.default.get(e,"siteData.coupons.coupons.length")>0?o.default.get(e,"siteData.coupons.identifiers")?me:o.default.noop:o.default.get(e,"siteData.coupons.type")==="tigger"&&s?(c&&n&&(e.siteData.coupons.shopify=!0,e.siteData.appliedCodeSelector=".applied-reduction-code__information",await U(o.default.assign(e,{domain:c,setSite:!0}))),!!(n||s==="Magento"||s==="WooCommerce"||s==="BigCommerce"||s==="Squarespace")?M:ge):o.default.get(e,"siteData.coupons.type")==="roo"?re.initCoupons:o.default.get(e,"siteData.coupons.type")==="asyncTigger"?o.default.get(e,"siteData.coupons.identifiers")?M:o.default.noop:o.default.noop}async function ye(e,s,c){if(e){let n=await s({experience:"checkout"});V=!0;let a=await f({message:"getClassifierCodes",domain:"amazon.com",pageData:e.pageData,pageViewId:t.get("pageViewId")});a&&(n.coupons=a),a&&a.length>=1&&(n.couponCount=a.length,D(n,c))}}function $e(e){let n=!1,a=e||0;return a=parseInt(a),isNaN(a)&&(n=!0,a=0),a>1e8?(n=!0,a=1e8):a<-1e8&&(n=!0,a=-1e8),{cleanedSavings:a,wasCleaned:n}}T(document.readyState);async function je({couponResult:e,triggerType:s,siteAPIData:c}={}){let{cleanedSavings:n,wasCleaned:a}=$e(e.savings),p=new Date().getTime()-o.default.get(e,"startTime")||null,u=Q(n,{noDollarSign:!0})??"0",m=o.default.round(parseFloat(u),2);await chrome.storage.local.set({lastCouponSavings:m});let g=await ze();S("track","tryCouponsResult",{triggerType:s,couponScriptType:e.couponScriptType,clickId:e.clickId,redirectId:G(e.clickId),couponRunId:e.couponRunId,cashback:e.cashback,deweyOriginalTotal:e.deweyOriginalTotal,originalTotal:e.originalTotal,originalTotalV2:e.originalTotalV2,baseTotal:e.baseTotal,finalTotal:e.finalTotal,savingsOld:e.savings||0,savings:n,savingsCurrency:c?.siteData?.merchantPage?.currency,savingsWasCleaned:a,shopifyLoggedIn:e.shopLoggedIn,couponReloadSkipped:e.couponReloadSkipped,errored:e.errored,runTime:e.runTime,runTimeV2:p,totalCouponsTested:o.default.get(e,"coupons.length"),coupons:o.default.get(e,"coupons"),originalCoupons:e.originalCoupons,preappliedCodes:e.preappliedCodes,bestCoupon:o.default.get(e,"bestCoupon.code"),platform:e.platform,cartData:g,actionLog:e.actionLog,currentLocation:o.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])})}We();
