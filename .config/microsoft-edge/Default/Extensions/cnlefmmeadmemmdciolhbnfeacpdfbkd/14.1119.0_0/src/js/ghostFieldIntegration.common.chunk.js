(self.webpackChunk=self.webpackChunk||[]).push([[748],{58155:(e,t,s)=>{s.r(t),s.d(t,{GhostFieldIntegration:()=>G});var i=s(90023),n=s(48546),r=s(72234),h=s(22299),a=s(13391),c=s(62552),o=s(90572),l=s(84178),_=s(47311),g=s(53976),d=s(58303),p=s(84358),u=s(88347),v=s(97340),b=s(75454),S=s(60774),x=s(23031),C=s(8261),k=s(25271),m=s(33487),f=s(17265),T=s(29561),y=s(22003),w=s(99454),D=s(60108),A=s(25961),E=s(65051),F=s(57462),U=s(84322),B=s(28625),I=s(47903),O=s(13272),P=s(47230),R=s(20182),M=s(81356);class G{constructor({doc:e,textField:t,domain:s,layout:r,createCheckingService:_,state:g,gnar:p,felog:u,textObserver:v,experimentClient:b,createTextRevisionManager:x=(e=>I.n.create(e)),originalTextField:C=t,textEventsTarget:m,customizations:f={},mapChange:F=i.yR,integrationName:O,fieldIntegrationStore:M}){this._initialSessionUUID=a.h.create(d.YP),this._disposables=[],this._checkingService=a.h.create(null),this._sduiBufferService=a.h.create(d.YP),this._publishedAckReceived=new c.X(!1),this._canDisposeCheckingService=new c.X(!1),this._canDisposeCheckingServicePromise=(0,n.n)(this._canDisposeCheckingService.pipe(o.h((e=>e)),l.q(1))),this._checkingStatus=a.h.create(D.H.idle),this._readyState=a.h.create(A.kQ.notReady),this._nativeSpellcheckEnabled=a.h.create(!1),this._generalScore=a.h.create(null),this._lowestGeneralScore=a.h.create(null),this._paragraphsCount=a.h.create(0),this._formattingSpansCount=a.h.create(0),this._requestAwaitService=new E.e,this._capiStartAckMessage=a.h.create(d.YP),this._isDisposed=!1,this._subs=[],this._domain=s,this._layout=r,this._createCheckingService=_,this._state=g,this._gnar=p,this._felog=u,this._textObserver=v,this._createTextRevisionManager=x,this._originalTextField=C,this._textEventsTarget=m,this._customizations=f,this._experimentClient=b,this._initialWebkitUserSelect=this._originalTextField.style.webkitUserSelect,this._mapChange=F,this._integrationName=O,this._textRevisionManager=this._createTextRevisionManager(v),this._disposables.push(this._textRevisionManager),this._disposables.push(this._alertProcessor),this._disposables.push(this._userEngagedByAlertsAcceptedService),this._doc=w.v.createOnCapi(e,{selectedLens:h.R.SpecialId.AllAlerts}),this._fieldIntegrationStore=M;const G=this._state.get().dynamicConfig.dlpEnabled&&"enabled"===this._experimentClient.getTreatment(P.p.ClientControlsDlpBuffering),z=this._experimentClient.isGateEnabled(R.K.TextChangeBufferUseLegacy),q=this._textObserver.getCurrentTextMap().getPlainText();this._alertProcessor=k.B.create(q,this._textRevisionManager,u);const N=U.ft,Y=z?new B.R(this.getUnmappedTextObserver().contentChanges.async,G?void 0:(0,S.qw)(this._originalTextField),!!this._customizations.richText,N):new U.fM(this.getUnmappedTextObserver().contentChanges.async,this._alertProcessor,G?void 0:(0,S.qw)(this._originalTextField),!!this._customizations.richText,N,!this._experimentClient.isGateEnabled(R.K.TextChangeBufferDontFlushOnApply));this._textChangeBuffer=Y,this._disposables.push(Y),this._textFieldAttrs=new T.Y(this._originalTextField,{spellcheck:"false"}),this._subs.push((0,y.H)({checkingService:this._checkingService,highlights:this._highlights,layout:this._layout,experimentClient:this._experimentClient,getAlertById:e=>this._alertProcessor.alerts.getAlertById(e)}).subscribe()),this._disposables.push(this._textFieldAttrs),Promise.resolve().then((()=>this._delayedStart()))}_isGBSigninCheckTextDisabled(){var e;const{user:t,page:s}=this._state.get();return(0,F.K)(t,s)&&(null!==(e=s.hideGBSigninPopupTodayTimestamp)&&void 0!==e?e:0)>Date.now()-r.pU}_delayedStart(){const{user:e,page:t}=this._state.get();M.n.isEdcBlocked(e)||this._isGBSigninCheckTextDisabled()||this._startCheckingText(!0===t.showOnboarding)}update(e){const t=this._checkingService.get();if(M.n.isEdcBlocked(e.user)||this._isGBSigninCheckTextDisabled())return null!==t&&(this._alertProcessor.removeAllAlerts({_tag:m.i.reset}),t.closeConnection(),this._checkingService.set(null)),void this._state.set(e);if(null!==t){const s=e.user,i=e.dapi.dialectStrong,n=this._state.get(),r=n.user,h=n.dapi.dialectStrong;s.id!==r.id||s.type!==r.type?(t.reconnect(),this._alertProcessor.removeAllAlerts({_tag:m.i.reset})):i!==h&&this._doc.settings.modify((e=>{const t={...e.context,dialect:d.ij(i)};return{...e,context:t}}))}else"ready"===e.extensionFSM.stage&&this._startCheckingText(!0===e.page.showOnboarding);this._state.set(e)}dispose(){var e;this._isDisposed||(this._isDisposed=!0,this._subs.forEach((e=>e.unsubscribe())),this._originalTextField.style.webkitUserSelect=this._initialWebkitUserSelect,[...this._disposables,this._textObserver,this._layout.textField.scroller].forEach((e=>{try{null==e||e.dispose()}catch(e){}})),null===(e=this._checkingService.get())||void 0===e||e.dispose(),_.timer(1e3).pipe(g.c(this._publishedAckReceived)).subscribe((e=>{e||this._canDisposeCheckingService.next(!0)})))}_startCheckingText(e){var t;if(null!==this._checkingService.get())return;const s=this._createCheckingService({doc:this._doc,mapChange:this._mapChange,integrationName:this._integrationName});this._checkingService.set(s),s.delayDisposeUntil(this._canDisposeCheckingServicePromise),this._subs.push(s.capiMessages.pipe(o.h((e=>"start"===e.action))).subscribe((e=>this._capiStartAckMessage.set(d.G(e))))),this._subs.push(s.capiEvents.pipe(o.h(v.hX.is("session_started"))).subscribe((e=>{this._initialSessionUUID.set(d.ij(e.sessionUuid))})));this._disposables.push(this._fieldIntegrationStore.registerFieldIntegration(b.O.ghost,null!==(t=this._textEventsTarget)&&void 0!==t?t:this._originalTextField,this._integrationName,this._textObserver)),this._checkingFeatureImpl=new f.O(this._state.view("user"),this._alertProcessor,s,this.getUnmappedTextObserver(),this._textRevisionManager,(()=>{}),(e=>this._checkingStatus.set(e)),(e=>this._readyState.set(e)),(e=>{this._fieldIntegrationController.setSiteSettings(e),this._checkDocContextSubscription()}),(e=>{this._textFieldAttrs.setAttributes({spellcheck:e.toString()}),this._nativeSpellcheckEnabled.set(e)}),(e=>(0,i.zG)(p.cS)),!!this._customizations.richText,(e=>this._generalScore.set(e||null)),(e=>this._lowestGeneralScore.set(e||null)),(e=>this._paragraphsCount.set(e)),(e=>this._formattingSpansCount.set(e)),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(()=>{(0,C.OB)().bgRpc.api.refreshUser("not_authorized")}),(e=>{this._statisticsService.wordsCount.set(e.wordsCount),this._statisticsService.charsCount.set(e.charsCount),this._statisticsService.sessionStats.set(e.sessionStats)}),(e=>{}),(e=>{}),(()=>this._canDisposeCheckingService.next(!0)),this._requestAwaitService.requests,this._textChangeBuffer,this._experimentClient,this._sduiBufferService.get()),this._checkingFeatureImpl.delayDisposeUntil(this._canDisposeCheckingServicePromise)}getUnmappedTextObserver(){return this._textObserver}addSubscription(e){this._isDisposed?e.unsubscribe():this._subs.push(e)}_checkDocContextSubscription(){var e;this._customizations.getDocEvents&&(null===(e=this._docEventsSubscription)||void 0===e||e.unsubscribe(),this._docEventsSubscription=this._customizations.getDocEvents(this._originalTextField).subscribe((e=>{var t,s;switch(e.type){case"docContextUpdated":{const s=this._sanitizeContextInfo(e.docContextInfo);(0,u.Qr)(s)||null===(t=this._checkingService.get())||void 0===t||t.updateContextInfo(s);break}case"published":null===(s=this._checkingService.get())||void 0===s||s.published();break;default:(0,x.vE)(e)}})),this._subs.push(this._docEventsSubscription))}_sanitizeContextInfo(e){const t=Object.keys(e),s=M.n.isGrammarlyEmployee(this._state.view("user").get());return t.reduce(((e,t)=>(O.t.fieldIsPrivate(t)&&!s&&delete e[t],e)),e)}}}}]);